# XX市大数据中心业务健康总览页 - 技术设计文档

## 1. 技术架构概述

### 1.1 整体架构
本项目采用前后端分离的架构模式，前端使用现代Web技术栈，后端提供RESTful API服务。

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端Web应用    │────│   后端API服务   │────│   数据源集成     │
│                 │    │                 │    │                 │
│ - React/Vue.js  │    │ - Node.js/Java  │    │ - 监控系统API   │
│ - D3.js/ECharts │    │ - Express/Spring│    │ - 安全系统API   │
│ - WebSocket     │    │ - Redis Cache   │    │ - CMDB系统      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 技术选型

#### 前端技术栈
- **框架**：React 18.x + TypeScript
- **状态管理**：Redux Toolkit + RTK Query
- **UI组件库**：Ant Design 5.x
- **数据可视化**：
  - D3.js v7 - 用于矩阵图的自定义可视化
  - Apache ECharts 5.x - 用于标准图表
- **样式**：CSS Modules + Less
- **构建工具**：Vite
- **实时通信**：WebSocket + Socket.io Client

#### 后端技术栈
- **运行环境**：Node.js 18.x
- **框架**：Express.js + TypeScript
- **数据库**：
  - PostgreSQL - 主数据存储
  - Redis - 缓存和会话存储
- **实时通信**：Socket.io
- **API文档**：Swagger/OpenAPI 3.0
- **监控**：Prometheus + Grafana

## 2. 前端架构设计

### 2.1 目录结构
```
src/
├── components/           # 公共组件
│   ├── common/          # 通用组件
│   ├── charts/          # 图表组件
│   └── layout/          # 布局组件
├── pages/               # 页面组件
│   └── dashboard/       # 仪表板页面
├── hooks/               # 自定义Hooks
├── services/            # API服务
├── store/               # 状态管理
├── utils/               # 工具函数
├── types/               # TypeScript类型定义
└── assets/              # 静态资源
```

### 2.2 核心组件设计

#### 2.2.1 组织树组件 (OrganizationTree)
```typescript
interface OrganizationTreeProps {
  data: OrganizationNode[];
  selectedPath: string[];
  onNodeSelect: (node: OrganizationNode) => void;
}

interface OrganizationNode {
  id: string;
  name: string;
  systemCount: number;
  healthStatus: HealthStatus;
  children?: OrganizationNode[];
}
```

**关键特性**：
- 横向滚动支持
- 虚拟滚动优化性能
- 节点状态指示器
- 路径高亮显示

#### 2.2.2 矩阵图组件 (HealthMatrixChart)
```typescript
interface HealthMatrixChartProps {
  systems: BusinessSystem[];
  dimensions: MatrixDimensions;
  onSystemClick: (system: BusinessSystem) => void;
  filterOptions: FilterOptions;
}

interface BusinessSystem {
  id: string;
  name: string;
  department: string;
  importance: ImportanceLevel;
  healthStatus: HealthStatus;
  assetCount: number;
  vulnerabilityCount: number;
  alertCount: number;
}
```

**技术实现**：
- 使用D3.js进行自定义可视化
- Canvas渲染优化大数据量性能
- 支持缩放和平移交互
- 响应式布局适配

#### 2.2.3 KPI指标卡组件 (KPICards)
```typescript
interface KPICardsProps {
  metrics: {
    totalSystems: number;
    abnormalSystems: number;
    urgentAlerts: number;
    criticalVulnerabilities: {
      count: number;
      affectedSystems: number;
    };
  };
}
```

### 2.3 状态管理设计

#### 2.3.1 Redux Store结构
```typescript
interface RootState {
  dashboard: {
    selectedOrganization: OrganizationNode | null;
    systems: BusinessSystem[];
    filters: FilterState;
    loading: boolean;
    error: string | null;
  };
  realtime: {
    alerts: Alert[];
    vulnerabilities: Vulnerability[];
    connected: boolean;
  };
  ui: {
    sidebarCollapsed: boolean;
    theme: 'light' | 'dark';
  };
}
```

#### 2.3.2 API查询定义（RTK Query）
```typescript
export const dashboardApi = createApi({
  reducerPath: 'dashboardApi',
  baseQuery: fetchBaseQuery({
    baseUrl: '/api/v1/',
  }),
  tagTypes: ['Systems', 'Alerts', 'Metrics'],
  endpoints: (builder) => ({
    getSystems: builder.query<BusinessSystem[], string>({
      query: (orgId) => `organizations/${orgId}/systems`,
      providesTags: ['Systems'],
    }),
    getMetrics: builder.query<DashboardMetrics, string>({
      query: (orgId) => `organizations/${orgId}/metrics`,
      providesTags: ['Metrics'],
    }),
  }),
});
```

## 3. 可视化技术实现

### 3.1 矩阵图实现方案

#### 3.1.1 D3.js实现架构
```typescript
class HealthMatrix {
  private svg: d3.Selection<SVGElement>;
  private canvas: d3.Selection<HTMLCanvasElement>;
  private context: CanvasRenderingContext2D;

  constructor(container: HTMLElement, options: MatrixOptions) {
    this.initializeCanvas(container);
    this.setupScales();
    this.bindEvents();
  }

  render(data: BusinessSystem[]) {
    this.clearCanvas();
    this.drawAxes();
    this.drawSystems(data);
    this.drawLegend();
  }

  private drawSystems(systems: BusinessSystem[]) {
    systems.forEach(system => {
      const x = this.xScale(system.department);
      const y = this.yScale(system.importance);
      const radius = this.radiusScale(system.assetCount);
      const color = this.colorScale(system.healthStatus);

      this.drawCircle(x, y, radius, color, system);
    });
  }
}
```

#### 3.1.2 性能优化策略
- **Canvas渲染**：使用Canvas替代SVG处理大量数据点
- **虚拟化**：只渲染可视区域内的元素
- **防抖处理**：交互事件防抖优化响应性能
- **Web Workers**：数据处理任务移到Worker线程

### 3.2 实时数据更新机制

#### 3.2.1 WebSocket连接管理
```typescript
class RealtimeManager {
  private socket: Socket;
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;

  connect() {
    this.socket = io(WS_ENDPOINT, {
      transports: ['websocket'],
      timeout: 5000,
    });

    this.socket.on('connect', this.handleConnect);
    this.socket.on('systemUpdate', this.handleSystemUpdate);
    this.socket.on('alertUpdate', this.handleAlertUpdate);
    this.socket.on('disconnect', this.handleDisconnect);
  }

  private handleSystemUpdate = (update: SystemUpdate) => {
    store.dispatch(updateSystemStatus(update));
  };
}
```

#### 3.2.2 数据更新策略
- **增量更新**：只更新变化的数据项
- **批量处理**：合并短时间内的多个更新
- **缓存策略**：智能缓存减少网络请求
- **错误重试**：网络异常时的自动重连机制

## 4. 后端架构设计

### 4.1 API设计

#### 4.1.1 RESTful API规范
```typescript
// 组织架构相关
GET    /api/v1/organizations              // 获取组织列表
GET    /api/v1/organizations/:id          // 获取指定组织信息
GET    /api/v1/organizations/:id/systems  // 获取组织下的系统列表

// 系统状态相关
GET    /api/v1/systems                    // 获取系统列表
GET    /api/v1/systems/:id                // 获取系统详情
GET    /api/v1/systems/:id/metrics        // 获取系统指标

// 告警相关
GET    /api/v1/alerts                     // 获取告警列表
POST   /api/v1/alerts/:id/acknowledge     // 确认告警

// 漏洞相关
GET    /api/v1/vulnerabilities            // 获取漏洞列表
GET    /api/v1/vulnerabilities/stats      // 获取漏洞统计
```

#### 4.1.2 数据模型定义
```typescript
interface BusinessSystem {
  id: string;
  name: string;
  description: string;
  department_id: string;
  department_name: string;
  importance_level: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  health_status: 'HEALTHY' | 'WARNING' | 'CRITICAL' | 'UNKNOWN';
  asset_count: number;
  created_at: Date;
  updated_at: Date;
}

interface SystemMetrics {
  system_id: string;
  error_rate: number;
  response_time: number;
  availability: number;
  cpu_usage: number;
  memory_usage: number;
  timestamp: Date;
}
```

### 4.2 数据集成方案

#### 4.2.1 数据源适配器
```typescript
abstract class DataSourceAdapter {
  abstract fetchSystems(): Promise<BusinessSystem[]>;
  abstract fetchMetrics(systemId: string): Promise<SystemMetrics>;
  abstract fetchAlerts(): Promise<Alert[]>;
}

class MonitoringSystemAdapter extends DataSourceAdapter {
  constructor(private config: MonitoringConfig) {
    super();
  }

  async fetchSystems(): Promise<BusinessSystem[]> {
    const response = await this.httpClient.get('/systems');
    return this.transformSystems(response.data);
  }
}
```

#### 4.2.2 数据处理管道
```typescript
class DataPipeline {
  private adapters: Map<string, DataSourceAdapter> = new Map();
  private cache: RedisClient;

  async processSystemData(): Promise<void> {
    const results = await Promise.allSettled([
      this.fetchFromMonitoring(),
      this.fetchFromSecurity(),
      this.fetchFromCMDB(),
    ]);

    const mergedData = this.mergeSystemData(results);
    await this.cache.setex('systems:all', 300, JSON.stringify(mergedData));

    this.broadcastUpdate(mergedData);
  }
}
```

## 5. 数据库设计

### 5.1 数据表结构

#### 5.1.1 核心业务表
```sql
-- 组织架构表
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(200) NOT NULL,
  parent_id UUID REFERENCES organizations(id),
  level INTEGER NOT NULL,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 业务系统表
CREATE TABLE business_systems (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(200) NOT NULL,
  description TEXT,
  organization_id UUID REFERENCES organizations(id),
  importance_level VARCHAR(20) NOT NULL,
  health_status VARCHAR(20) NOT NULL,
  asset_count INTEGER DEFAULT 0,
  external_id VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 系统指标表
CREATE TABLE system_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  system_id UUID REFERENCES business_systems(id),
  metric_type VARCHAR(50) NOT NULL,
  metric_value DECIMAL(10,4),
  timestamp TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 5.1.2 索引设计
```sql
-- 性能优化索引
CREATE INDEX idx_systems_org_status ON business_systems(organization_id, health_status);
CREATE INDEX idx_metrics_system_time ON system_metrics(system_id, timestamp DESC);
CREATE INDEX idx_alerts_system_time ON alerts(system_id, created_at DESC);
```

### 5.2 缓存策略

#### 5.2.1 Redis缓存设计
```typescript
interface CacheKeys {
  SYSTEMS_BY_ORG: 'systems:org:{orgId}';
  SYSTEM_METRICS: 'metrics:system:{systemId}';
  ALERT_SUMMARY: 'alerts:summary:{orgId}';
  VULNERABILITY_STATS: 'vuln:stats:{orgId}';
}

const CACHE_TTL = {
  SYSTEMS: 300,      // 5分钟
  METRICS: 60,       // 1分钟
  ALERTS: 30,        // 30秒
  VULNERABILITIES: 600, // 10分钟
};
```

## 6. 安全设计

### 6.1 认证授权
- **JWT令牌**：基于JWT的无状态认证
- **RBAC权限**：基于角色的访问控制
- **API网关**：统一的安全策略入口

### 6.2 数据安全
- **传输加密**：全站HTTPS，敏感API使用TLS 1.3
- **数据脱敏**：敏感信息在前端展示时脱敏处理
- **审计日志**：完整的操作审计日志

### 6.3 前端安全
- **XSS防护**：内容安全策略（CSP）
- **CSRF防护**：双重令牌验证
- **依赖安全**：定期扫描第三方依赖漏洞

## 7. 性能优化

### 7.1 前端性能优化
- **代码分割**：路由级别的懒加载
- **虚拟化**：大列表虚拟滚动
- **缓存策略**：HTTP缓存 + Service Worker
- **资源优化**：图片压缩、字体子集化

### 7.2 后端性能优化
- **连接池**：数据库连接池管理
- **查询优化**：SQL查询优化和索引设计
- **负载均衡**：多实例负载均衡
- **缓存层**：多级缓存策略

## 8. 监控与运维

### 8.1 应用监控
- **性能监控**：页面加载时间、API响应时间
- **错误监控**：前端错误收集和分析
- **用户行为**：用户操作路径分析

### 8.2 系统监控
- **服务监控**：服务可用性和性能指标
- **资源监控**：CPU、内存、磁盘使用率
- **业务监控**：关键业务指标监控

## 9. 部署方案

### 9.1 容器化部署
```dockerfile
# 前端Dockerfile
FROM node:18-alpine as builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
```

### 9.2 CI/CD流程
```yaml
# GitHub Actions工作流
name: Deploy Dashboard
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm test
      - name: Build application
        run: npm run build
      - name: Deploy to production
        run: kubectl apply -f k8s/
```

## 10. 开发规范

### 10.1 代码规范
- **ESLint + Prettier**：代码格式化和质量检查
- **TypeScript**：严格的类型检查
- **Git Hooks**：提交前自动检查

### 10.2 测试策略
- **单元测试**：Jest + React Testing Library
- **集成测试**：API接口测试
- **E2E测试**：Playwright端到端测试
- **性能测试**：Lighthouse性能评估

### 10.3 文档管理
- **API文档**：Swagger自动生成
- **组件文档**：Storybook组件展示
- **部署文档**：详细的部署和运维文档