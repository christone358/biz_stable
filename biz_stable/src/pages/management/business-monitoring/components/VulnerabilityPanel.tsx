import React, { useState } from 'react'
import { Card, Row, Col, Statistic, Table, Tag, Button, Space, Typography } from 'antd'
import { BugOutlined, EyeOutlined } from '@ant-design/icons'
import dayjs from 'dayjs'
import { VulnerabilitySummary, VulnerabilityDetail } from '../types'
import './VulnerabilityPanel.css'

const { Title, Text } = Typography

interface VulnerabilityPanelProps {
  summary: VulnerabilitySummary
  details: VulnerabilityDetail[]
}

const VulnerabilityPanel: React.FC<VulnerabilityPanelProps> = ({ summary, details }) => {
  const [expandedPanel, setExpandedPanel] = useState(false)

  // 严重程度配置
  const severityConfig = {
    CRITICAL: { color: '#FF4D4F', label: '严重' },
    HIGH: { color: '#FF7A45', label: '高危' },
    MEDIUM: { color: '#FAAD14', label: '中危' },
    LOW: { color: '#52C41A', label: '低危' }
  }

  // 状态配置
  const statusConfig = {
    OPEN: { color: 'red', label: '待处理' },
    FIXING: { color: 'orange', label: '修复中' },
    RESOLVED: { color: 'green', label: '已修复' }
  }

  // 表格列定义
  const columns = [
    {
      title: '漏洞标题',
      dataIndex: 'title',
      key: 'title',
      width: 200,
      render: (text: string, record: VulnerabilityDetail) => (
        <Space direction="vertical" size={0}>
          <Text strong>{text}</Text>
          {record.cveId && <Text type="secondary" style={{ fontSize: '12px' }}>{record.cveId}</Text>}
        </Space>
      )
    },
    {
      title: '严重程度',
      dataIndex: 'severity',
      key: 'severity',
      width: 100,
      align: 'center' as const,
      render: (severity: keyof typeof severityConfig) => (
        <Tag color={severityConfig[severity].color}>{severityConfig[severity].label}</Tag>
      )
    },
    {
      title: 'CVSS评分',
      dataIndex: 'cvssScore',
      key: 'cvssScore',
      width: 100,
      align: 'center' as const,
      render: (score: number) => (
        <Text strong style={{ color: score >= 9 ? '#FF4D4F' : score >= 7 ? '#FAAD14' : '#52C41A' }}>
          {score.toFixed(1)}
        </Text>
      )
    },
    {
      title: '影响资产',
      dataIndex: 'affectedAsset',
      key: 'affectedAsset',
      width: 150
    },
    {
      title: '发现时间',
      dataIndex: 'discoveryDate',
      key: 'discoveryDate',
      width: 120,
      render: (date: string) => dayjs(date).format('YYYY-MM-DD')
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      width: 100,
      align: 'center' as const,
      render: (status: keyof typeof statusConfig) => (
        <Tag color={statusConfig[status].color}>{statusConfig[status].label}</Tag>
      )
    },
    {
      title: '操作',
      key: 'action',
      width: 100,
      align: 'center' as const,
      render: (_: any, record: VulnerabilityDetail) => (
        <Button
          type="link"
          size="small"
          icon={<EyeOutlined />}
          onClick={() => console.log('查看漏洞详情:', record.id)}
        >
          详情
        </Button>
      )
    }
  ]

  return (
    <Card
      title={
        <Space>
          <BugOutlined style={{ color: '#FF4D4F' }} />
          <span>脆弱性动态</span>
        </Space>
      }
      className="vulnerability-panel"
      bordered={false}
      bodyStyle={{ padding: 24 }}
      extra={
        <Button
          type="link"
          onClick={() => setExpandedPanel(!expandedPanel)}
        >
          {expandedPanel ? '收起' : '展开详情'}
        </Button>
      }
    >
      {/* 统计概览 */}
      <div className="vulnerability-summary">
        <Row gutter={24}>
          <Col xs={24} sm={12} md={6}>
            <div className="summary-item critical">
              <Statistic
                title="严重"
                value={summary.critical}
                suffix="个"
                valueStyle={{ color: '#FF4D4F', fontSize: '24px', fontWeight: 600 }}
              />
            </div>
          </Col>
          <Col xs={24} sm={12} md={6}>
            <div className="summary-item high">
              <Statistic
                title="高危"
                value={summary.high}
                suffix="个"
                valueStyle={{ color: '#FF7A45', fontSize: '24px', fontWeight: 600 }}
              />
            </div>
          </Col>
          <Col xs={24} sm={12} md={6}>
            <div className="summary-item medium">
              <Statistic
                title="中危"
                value={summary.medium}
                suffix="个"
                valueStyle={{ color: '#FAAD14', fontSize: '24px', fontWeight: 600 }}
              />
            </div>
          </Col>
          <Col xs={24} sm={12} md={6}>
            <div className="summary-item low">
              <Statistic
                title="低危"
                value={summary.low}
                suffix="个"
                valueStyle={{ color: '#52C41A', fontSize: '24px', fontWeight: 600 }}
              />
            </div>
          </Col>
        </Row>
      </div>

      {/* 详细列表 */}
      {expandedPanel && (
        <div className="vulnerability-details" style={{ marginTop: 16 }}>
          <Table
            columns={columns}
            dataSource={details}
            rowKey="id"
            size="middle"
            pagination={{
              pageSize: 20,
              showSizeChanger: true,
              showTotal: (total) => `共 ${total} 条`
            }}
            scroll={{ x: 900 }}
          />
        </div>
      )}
    </Card>
  )
}

export default VulnerabilityPanel
