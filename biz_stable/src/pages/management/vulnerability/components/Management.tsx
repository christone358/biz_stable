import React, { useState, useMemo, useCallback, useEffect } from 'react'
import { Card, Table, Button, Input, Select, Space, Drawer, Descriptions, Tag, Modal, Form, DatePicker, message } from 'antd'
import type { ColumnsType } from 'antd/es/table'
import VulnerabilityFilter, { type FilterSelection } from './VulnerabilityFilter'
import type {
  VulnerabilityRecord,
  VulnerabilityLevel,
  VulnerabilityStatus,
  FilterConditions
} from '../types'
import { DimensionType } from '../types'
import { generateVulnerabilityRecords, getBusinessNamesFromNode, getDepartmentName, generateBusinessVulnerabilityTree, generateDepartmentVulnerabilityList } from '../../../../mock/vulnerability-data'
import './Management.css'

const { TextArea } = Input

export interface ManagementFilterPreset {
  keyword?: string
  source?: string
  hostId?: string
  hostName?: string
  hostIp?: string
  filterType?: string
  [key: string]: string | undefined
}

interface ManagementProps {
  initialFilter?: ManagementFilterPreset | null
}

const Management: React.FC<ManagementProps> = ({ initialFilter }) => {
  // 状态管理
  const [filterSelection, setFilterSelection] = useState<FilterSelection>({
    viewType: 'business',
    selectedId: 'all'
  })
  const [records] = useState<VulnerabilityRecord[]>(() => generateVulnerabilityRecords())
  const [filterConditions, setFilterConditions] = useState<FilterConditions>({
    keyword: '',
    level: 'all',
    status: 'all',
    businessSystem: 'all',
    dimension: DimensionType.AFFECTED_BUSINESS,
    selectedTreeNode: 'all'
  })
  const [selectedRowKeys, setSelectedRowKeys] = useState<string[]>([])
  const [detailDrawerVisible, setDetailDrawerVisible] = useState(false)
  const [assignModalVisible, setAssignModalVisible] = useState(false)
  const [selectedRecord, setSelectedRecord] = useState<VulnerabilityRecord | null>(null)
  const [assignForm] = Form.useForm()
  const [pagination, setPagination] = useState({ current: 1, pageSize: 20 })

  useEffect(() => {
    if (initialFilter && typeof initialFilter.keyword === 'string') {
      setFilterConditions(prev => ({
        ...prev,
        keyword: initialFilter.keyword ?? ''
      }))
      setPagination(prev => ({ ...prev, current: 1 }))
    }
  }, [initialFilter])

  // 筛选器变更处理
  const handleFilterChange = useCallback((selection: FilterSelection) => {
    setFilterSelection(selection)
    setFilterConditions((prev: FilterConditions) => ({
      ...prev,
      dimension: selection.viewType === 'business'
        ? DimensionType.AFFECTED_BUSINESS
        : DimensionType.REPAIR_DEPARTMENT,
      selectedTreeNode: selection.selectedId || 'all'
    }))
  }, [])

  // 筛选后的记录
  const filteredRecords = useMemo(() => {
    return records.filter((record) => {
      // 左侧树形筛选联动
      if (filterSelection.selectedId && filterSelection.selectedId !== 'all') {
        if (filterSelection.viewType === 'business') {
          // 业务视角筛选
          if (filterSelection.selectedId === 'business-unknown') {
            // 未知业务：只显示businessSystem为"未知业务"的记录
            if (record.businessSystem !== '未知业务') {
              return false
            }
          } else {
            // 获取选中节点下的所有业务系统名称
            const allowedBusinesses = getBusinessNamesFromNode(filterSelection.selectedId)
            if (allowedBusinesses.length > 0 && !allowedBusinesses.includes(record.businessSystem)) {
              return false
            }
          }
        } else if (filterSelection.viewType === 'department') {
          // 部门视角筛选
          const departmentName = getDepartmentName(filterSelection.selectedId)
          if (departmentName === '') {
            // 未指派单位：筛选没有部门或部门为空的记录
            if (record.department && record.department.trim() !== '') {
              return false
            }
          } else if (departmentName !== null) {
            // 指定部门：筛选该部门的记录
            if (record.department !== departmentName) {
              return false
            }
          }
        }
      }

      // 关键字筛选
      const keyword = filterConditions.keyword.trim().toLowerCase()
      if (keyword) {
        const keywordTargets = [
          record.name,
          record.cveNumber,
          record.assetName || '',
          record.ipAddress || ''
        ].map(value => value.toLowerCase())
        if (!keywordTargets.some(target => target.includes(keyword))) {
          return false
        }
      }

      // 等级筛选
      if (filterConditions.level !== 'all' && record.level !== filterConditions.level) {
        return false
      }

      // 状态筛选
      if (filterConditions.status !== 'all' && record.status !== filterConditions.status) {
        return false
      }

      // 业务系统筛选（右侧操作栏的筛选）
      if (filterConditions.businessSystem !== 'all' && record.businessSystem !== filterConditions.businessSystem) {
        return false
      }

      return true
    })
  }, [records, filterConditions, filterSelection])

  // 获取节点名称的辅助函数
  const getNodeName = useCallback((nodeId: string, viewType: 'business' | 'department'): string => {
    if (nodeId === 'all') return '全部'
    if (nodeId === 'business-unknown') return '未知业务'
    if (nodeId === 'dept-unassigned') return '未指派单位'

    if (viewType === 'business') {
      // 从业务树中递归查找节点名称
      const businessTree = generateBusinessVulnerabilityTree()

      const findNodeName = (nodes: any[], targetId: string): string | null => {
        for (const node of nodes) {
          if (node.id === targetId) {
            return node.name
          }
          if (node.children) {
            const result = findNodeName(node.children, targetId)
            if (result) return result
          }
        }
        return null
      }

      const name = findNodeName(businessTree.businesses, nodeId)
      return name || nodeId
    } else {
      // 从部门列表中查找名称
      const departmentList = generateDepartmentVulnerabilityList()
      const dept = departmentList.departments.find(d => d.id === nodeId)
      return dept ? dept.name : nodeId
    }
  }, [])

  // 计算当前选择的统计信息
  const currentStats = useMemo(() => {
    const stats = {
      name: getNodeName(filterSelection.selectedId || 'all', filterSelection.viewType),
      total: filteredRecords.length,
      affectHost: filteredRecords.filter(r => r.affectType === 'host').length,
      affectMiddleware: filteredRecords.filter(r => r.affectType === 'middleware').length,
      affectApplication: filteredRecords.filter(r => r.affectType === 'application').length,
      high: filteredRecords.filter(r => r.level === 'high').length,
      medium: filteredRecords.filter(r => r.level === 'medium').length,
      low: filteredRecords.filter(r => r.level === 'low').length,
      info: filteredRecords.filter(r => r.level === 'info').length
    }

    return stats
  }, [filteredRecords, filterSelection, getNodeName])

  // 表格列定义
  const columns: ColumnsType<VulnerabilityRecord> = [
    {
      title: '脆弱性名称',
      dataIndex: 'name',
      key: 'name',
      width: 200,
      ellipsis: true
    },
    {
      title: 'CVE编号',
      dataIndex: 'cveNumber',
      key: 'cveNumber',
      width: 150
    },
    {
      title: '风险等级',
      dataIndex: 'level',
      key: 'level',
      width: 100,
      align: 'center',
      render: (level: VulnerabilityLevel) => {
        const config: Record<VulnerabilityLevel, { color: string, text: string }> = {
          high: { color: 'error', text: '高危' },
          medium: { color: 'warning', text: '中危' },
          low: { color: 'success', text: '低危' },
          info: { color: 'default', text: '信息' }
        }
        const { color, text } = config[level]
        return <Tag color={color}>{text}</Tag>
      }
    },
    {
      title: '业务系统',
      dataIndex: 'businessSystem',
      key: 'businessSystem',
      width: 150,
      ellipsis: true
    },
    {
      title: '关联资产',
      key: 'asset',
      width: 180,
      render: (_, record) => (
        <div style={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
          <span style={{ fontSize: 12, color: '#595959' }}>{record.assetName}</span>
          <span style={{ fontSize: 12, color: '#8c8c8c' }}>{record.ipAddress}</span>
        </div>
      )
    },
    {
      title: '发现时间',
      dataIndex: 'discoveredTime',
      key: 'discoveredTime',
      width: 180
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      width: 100,
      align: 'center',
      render: (status: VulnerabilityStatus) => {
        const config: Record<VulnerabilityStatus, { color: string, text: string }> = {
          pending: { color: 'warning', text: '待处理' },
          processing: { color: 'processing', text: '处理中' },
          resolved: { color: 'success', text: '已解决' },
          overdue: { color: 'error', text: '已超期' }
        }
        const { color, text } = config[status]
        return <Tag color={color}>{text}</Tag>
      }
    },
    {
      title: '操作',
      key: 'actions',
      width: 150,
      fixed: 'right',
      render: (_, record) => (
        <Space>
          <Button type="link" size="small" onClick={() => handleViewDetail(record)}>
            查看详情
          </Button>
          {record.status === 'pending' ? (
            <Button type="link" size="small" onClick={() => handleAssign(record)}>
              派发任务
            </Button>
          ) : (
            <Button type="link" size="small" onClick={() => handleAssign(record)}>
              重新派发
            </Button>
          )}
        </Space>
      )
    }
  ]

  // 查看详情
  const handleViewDetail = (record: VulnerabilityRecord) => {
    setSelectedRecord(record)
    setDetailDrawerVisible(true)
  }

  // 派发任务
  const handleAssign = (record: VulnerabilityRecord) => {
    setSelectedRecord(record)
    setAssignModalVisible(true)
    assignForm.resetFields()
  }

  // 批量派发
  const handleBatchAssign = () => {
    if (selectedRowKeys.length === 0) {
      message.warning('请先选择要派发的脆弱性')
      return
    }
    setAssignModalVisible(true)
    assignForm.resetFields()
  }

  // 提交派发任务
  const handleSubmitAssign = async () => {
    try {
      await assignForm.validateFields()
      message.success('任务派发成功！')
      setAssignModalVisible(false)
      setSelectedRowKeys([])
    } catch (error) {
      console.error('表单验证失败:', error)
    }
  }

  // 导出数据
  const handleExport = () => {
    message.success('正在导出数据...')
  }

  // 行选择配置
  const rowSelection = {
    selectedRowKeys,
    onChange: (keys: React.Key[]) => {
      setSelectedRowKeys(keys as string[])
    }
  }

  return (
    <div className="vulnerability-management">
      <div className="management-layout">
        {/* 左侧树形筛选 */}
        <div className="management-sidebar">
          <VulnerabilityFilter onFilterChange={handleFilterChange} />
        </div>

        {/* 右侧内容区 */}
        <div className="management-content">
          {/* 统计卡片区域 */}
          <Card className="stats-card">
            <div className="stats-header">
              <h3 className="stats-title">{currentStats.name}</h3>
              <span className="stats-total">共 {currentStats.total} 个脆弱性</span>
            </div>

            <div className="stats-grid">
              {/* 影响范围统计 */}
              <div className="stats-section">
                <div className="stats-section-title">影响范围</div>
                <div className="stats-items">
                  <div className="stats-item">
                    <span className="stats-label">影响主机</span>
                    <span className="stats-value">{currentStats.affectHost}</span>
                  </div>
                  <div className="stats-item">
                    <span className="stats-label">影响中间件</span>
                    <span className="stats-value">{currentStats.affectMiddleware}</span>
                  </div>
                  <div className="stats-item">
                    <span className="stats-label">影响应用</span>
                    <span className="stats-value">{currentStats.affectApplication}</span>
                  </div>
                </div>
              </div>

              {/* 严重程度统计 */}
              <div className="stats-section">
                <div className="stats-section-title">严重程度</div>
                <div className="stats-items">
                  <div className="stats-item">
                    <span className="stats-label">高危</span>
                    <span className="stats-value stats-value-high">{currentStats.high}</span>
                  </div>
                  <div className="stats-item">
                    <span className="stats-label">中危</span>
                    <span className="stats-value stats-value-medium">{currentStats.medium}</span>
                  </div>
                  <div className="stats-item">
                    <span className="stats-label">低危</span>
                    <span className="stats-value stats-value-low">{currentStats.low}</span>
                  </div>
                  <div className="stats-item">
                    <span className="stats-label">提示</span>
                    <span className="stats-value stats-value-info">{currentStats.info}</span>
                  </div>
                </div>
              </div>
            </div>
          </Card>

          {/* 脆弱性列表 */}
          <Card>
            <Table
              dataSource={filteredRecords}
              columns={columns}
              rowKey="id"
              rowSelection={rowSelection}
              title={() => (
                <div className="table-header">
                  <Space wrap>
                    <Input
                      placeholder="搜索脆弱性名称、CVE编号..."
                      style={{ width: 200 }}
                      value={filterConditions.keyword}
                      onChange={(e) =>
                        setFilterConditions((prev) => ({ ...prev, keyword: e.target.value }))
                      }
                      allowClear
                    />
                    <Select
                      placeholder="风险等级"
                      style={{ width: 140 }}
                      value={filterConditions.level}
                      onChange={(value) => setFilterConditions((prev) => ({ ...prev, level: value }))}
                      options={[
                        { value: 'all', label: '全部风险等级' },
                        { value: 'high', label: '高危' },
                        { value: 'medium', label: '中危' },
                        { value: 'low', label: '低危' },
                        { value: 'info', label: '信息' }
                      ]}
                    />
                    <Select
                      placeholder="状态"
                      style={{ width: 120 }}
                      value={filterConditions.status}
                      onChange={(value) => setFilterConditions((prev) => ({ ...prev, status: value }))}
                      options={[
                        { value: 'all', label: '全部状态' },
                        { value: 'pending', label: '待处理' },
                        { value: 'processing', label: '处理中' },
                        { value: 'resolved', label: '已解决' },
                        { value: 'overdue', label: '已超期' }
                      ]}
                    />
                    <Button type="primary" onClick={() => setPagination({ ...pagination, current: 1 })}>
                      查询
                    </Button>
                    <Button onClick={() => setFilterConditions((prev: FilterConditions) => ({
                      ...prev,
                      keyword: '',
                      level: 'all',
                      status: 'all',
                      businessSystem: 'all'
                    }))}>
                      重置
                    </Button>
                  </Space>
                  <Space style={{ marginLeft: 'auto' }}>
                    <Button type="primary" onClick={handleBatchAssign}>
                      批量派发
                    </Button>
                    <Button onClick={handleExport}>导出数据</Button>
                  </Space>
                </div>
              )}
              pagination={{
                ...pagination,
                total: filteredRecords.length,
                showSizeChanger: true,
                showQuickJumper: true,
                showTotal: (total) => `共 ${total} 条记录`,
                onChange: (page, pageSize) => setPagination({ current: page, pageSize })
              }}
              scroll={{ x: 1200 }}
            />
          </Card>
        </div>
      </div>

      {/* 详情抽屉 */}
      <Drawer
        title="脆弱性详情"
        open={detailDrawerVisible}
        onClose={() => setDetailDrawerVisible(false)}
        width={720}
        extra={
          <Space>
            <Button type="primary" onClick={() => {
              handleAssign(selectedRecord!)
              setDetailDrawerVisible(false)
            }}>
              派发任务
            </Button>
            <Button onClick={() => setDetailDrawerVisible(false)}>关闭</Button>
          </Space>
        }
      >
        {selectedRecord && (
          <div>
            <Descriptions title="基本信息" column={2} bordered>
              <Descriptions.Item label="脆弱性名称" span={2}>
                {selectedRecord.name}
              </Descriptions.Item>
              <Descriptions.Item label="CVE编号">{selectedRecord.cveNumber}</Descriptions.Item>
              <Descriptions.Item label="风险等级">
                <Tag color={selectedRecord.level === 'high' ? 'error' : selectedRecord.level === 'medium' ? 'warning' : 'success'}>
                  {selectedRecord.level === 'high' ? '高危' : selectedRecord.level === 'medium' ? '中危' : '低危'}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="CVSS评分">{selectedRecord.cvssScore.toFixed(1)}</Descriptions.Item>
              <Descriptions.Item label="业务系统">{selectedRecord.businessSystem}</Descriptions.Item>
              <Descriptions.Item label="资产名称">{selectedRecord.assetName}</Descriptions.Item>
              <Descriptions.Item label="IP地址">{selectedRecord.ipAddress}</Descriptions.Item>
              <Descriptions.Item label="发现时间">{selectedRecord.discoveredTime}</Descriptions.Item>
              <Descriptions.Item label="当前状态">
                <Tag color={selectedRecord.status === 'pending' ? 'warning' : selectedRecord.status === 'processing' ? 'processing' : 'success'}>
                  {selectedRecord.status === 'pending' ? '待处理' : selectedRecord.status === 'processing' ? '处理中' : '已解决'}
                </Tag>
              </Descriptions.Item>
            </Descriptions>

            <Descriptions title="漏洞描述" column={1} bordered style={{ marginTop: 24 }}>
              <Descriptions.Item>{selectedRecord.description}</Descriptions.Item>
            </Descriptions>

            <Descriptions title="影响范围" column={1} bordered style={{ marginTop: 24 }}>
              <Descriptions.Item>{selectedRecord.affectedScope}</Descriptions.Item>
            </Descriptions>

            <Descriptions title="修复建议" column={1} bordered style={{ marginTop: 24 }}>
              <Descriptions.Item>
                <div style={{ whiteSpace: 'pre-line' }}>{selectedRecord.fixSuggestion}</div>
              </Descriptions.Item>
            </Descriptions>

            <Descriptions title="处理记录" column={1} bordered style={{ marginTop: 24 }}>
              <Descriptions.Item>
                {selectedRecord.processingRecords.map((record) => (
                  <div key={record.id} style={{ marginBottom: 12 }}>
                    <strong>{record.timestamp}</strong> - {record.action}
                  </div>
                ))}
              </Descriptions.Item>
            </Descriptions>
          </div>
        )}
      </Drawer>

      {/* 派发任务模态框 */}
      <Modal
        title="派发任务"
        open={assignModalVisible}
        onOk={handleSubmitAssign}
        onCancel={() => setAssignModalVisible(false)}
        okText="确认派发"
        cancelText="取消"
        width={600}
      >
        <Form form={assignForm} layout="vertical">
          <Form.Item
            label="派发给"
            name="department"
            rules={[{ required: true, message: '请选择责任单位' }]}
          >
            <Select
              placeholder="请选择责任单位"
              options={[
                { value: 'dept1', label: '基础架构组' },
                { value: 'dept2', label: '支付开发部' },
                { value: 'dept3', label: '用户中心开发部' },
                { value: 'dept4', label: '订单运营组' },
                { value: 'dept5', label: '数据平台组' }
              ]}
            />
          </Form.Item>

          <Form.Item
            label="处理人"
            name="assignee"
            rules={[{ required: true, message: '请选择处理人' }]}
          >
            <Select
              placeholder="请选择处理人"
              options={[
                { value: 'user1', label: '赵六' },
                { value: 'user2', label: '王五' },
                { value: 'user3', label: '李四' },
                { value: 'user4', label: '张三' },
                { value: 'user5', label: '钱七' }
              ]}
            />
          </Form.Item>

          <Form.Item label="优先级" name="priority" initialValue="medium">
            <Select
              options={[
                { value: 'high', label: '高' },
                { value: 'medium', label: '中' },
                { value: 'low', label: '低' }
              ]}
            />
          </Form.Item>

          <Form.Item
            label="要求完成时间"
            name="deadline"
            rules={[{ required: true, message: '请选择完成时间' }]}
          >
            <DatePicker style={{ width: '100%' }} />
          </Form.Item>

          <Form.Item label="处理说明" name="instructions">
            <TextArea rows={4} placeholder="请输入处理说明或要求..." />
          </Form.Item>
        </Form>
      </Modal>
    </div>
  )
}

export default Management
