import React, { useState, useEffect } from 'react'
import { Tabs } from 'antd'
import type { TabsProps } from 'antd'
import { useLocation } from 'react-router-dom'
import Overview from './components/Overview'
import Management, { type ManagementFilterPreset } from './components/Management'
import './index.css'

const VulnerabilityPage: React.FC = () => {
  const [activeTab, setActiveTab] = useState<'overview' | 'management'>('overview')
  const [managementFilter, setManagementFilter] = useState<ManagementFilterPreset | null>(null)
  const location = useLocation()

  useEffect(() => {
    const params = new URLSearchParams(location.search)
    const viewParam = params.get('view')
    const hostId = params.get('hostId') || undefined
    const hostName = params.get('hostName') || undefined
    const hostIp = params.get('hostIp') || undefined
    const hasHostFilter = Boolean(hostId || hostName || hostIp)

    if (viewParam === 'management' || hasHostFilter) {
      setActiveTab('management')
    }

    if (hasHostFilter) {
      setManagementFilter({
        source: 'cloud-host',
        hostId,
        hostName,
        hostIp,
        keyword: hostIp || hostName || ''
      })
    }
  }, [location.search])

  // 从总览页面切换到管理页面
  const handleSwitchToManagement = (filter?: ManagementFilterPreset) => {
    setManagementFilter(filter ?? null)
    setActiveTab('management')
  }

  const items: TabsProps['items'] = [
    {
      key: 'overview',
      label: '脆弱性总览',
      children: <Overview onSwitchToManagement={handleSwitchToManagement} />
    },
    {
      key: 'management',
      label: '脆弱性管理',
      children: <Management initialFilter={managementFilter} />
    }
  ]

  return (
    <div className="vulnerability-page">
      <Tabs
        activeKey={activeTab}
        onChange={(key) => setActiveTab(key as 'overview' | 'management')}
        size="large"
        type="line"
        items={items}
      />
    </div>
  )
}

export default VulnerabilityPage
