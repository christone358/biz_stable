# 告警监测功能设计文档

## 文档说明
本文档从产品和架构角度描述告警监测功能的设计思路、功能组织和交互逻辑。

**最后更新时间**: 2025-10-15
**开发状态**: 已完成
**对应页面**: `/src/pages/management/alert-monitoring/`
**路由路径**: `/management/alert-monitoring`

---

## 1. 功能概述

### 1.1 业务背景

告警监测是运维工作的核心功能，汇集来自各监控系统（Zabbix、Prometheus、云监控等）的告警信息，提供统一的告警查看、筛选和处理入口。运维人员每天需要处理大量告警，快速识别和响应关键告警是保障业务稳定的关键。

### 1.2 核心目标

1. **统一告警视图**: 汇总多个监控源的告警，统一展示
2. **快速筛选**: 多维度筛选，快速定位关键告警
3. **优先级管理**: 按等级和状态组织告警，突出紧急告警
4. **协同处理**: 支持指派、关闭、批量操作等协同功能

### 1.3 用户角色

- **值班运维**: 7×24小时值守，处理紧急告警
- **系统运维**: 负责特定系统，处理分配给自己的告警
- **运维主管**: 查看告警统计，评估运维质量

---

## 2. 用户场景

### 场景1：值班运维日常巡检

王工今天值班，早上上班第一件事是查看告警：
1. 打开告警监测页面
2. 页面自动刷新，显示最新告警
3. 快速筛选：点击"严重"等级标签
4. 看到3条严重告警：
   - 数据库连接池耗尽（未处理）
   - 磁盘使用率95%（处理中）
   - API响应超时（未处理）
5. 点击第一条告警，查看详情
6. 确认是应用bug导致连接未释放
7. 点击"指派"，分配给应用开发组
8. 添加处理说明："连接池泄漏，请排查代码"
9. 继续处理下一条告警

### 场景2：按资源类型定位告警

李工收到短信：某数据库告警
1. 打开告警监测页面
2. 左侧资源树展开"数据库"分类
3. 勾选"MySQL"和"Redis"
4. 右侧列表自动筛选，只显示这两类资源的告警
5. 找到目标告警："mysql-01 主从延迟"
6. 查看告警详情，分析原因
7. 在告警上添加备注："已重启从库，恢复正常"
8. 点击"关闭告警"

### 场景3：批量处理过期告警

张主管发现很多已处理的告警未关闭：
1. 打开告警监测页面
2. 快速筛选：状态选择"已处理"
3. 时间范围选择"7天前"
4. 列表显示20条旧告警
5. 全选当前页
6. 点击"批量关闭"
7. 填写关闭原因："已处理超过7天，批量关闭"
8. 确认关闭，列表刷新

---

## 3. 页面布局设计

### 3.1 整体布局

```
┌─────────────────────────────────────────────────────────────────┐
│ 首页 > 业务保障管理 > 资产告警监测                               │
│ 时间范围: [2023-07-15 ~ 2023-07-16] ▼                          │
│ 自动刷新: [ON] 30秒 ▼                                            │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┬──────────────────────────────────────────────────┐
│              │  快速筛选                                          │
│  资源目录树  │  [严重 23] [重要 45] [次要 12] [提示 8]          │
│  (260px)     │  [未处理 56] [处理中 18] [已处理 14]             │
│              ├──────────────────────────────────────────────────┤
│  监控源      │  告警列表                                          │
│  ├─ Zabbix  │  ┌──────────────────────────────────────────────┐│
│  └─ Prom... │  │ [批量指派] [批量关闭] [导出]                  ││
│              │  ├──────────────────────────────────────────────┤│
│  资源类型    │  │ ☑ 等级  │ 告警名称          │ 资源    │ 时间 ││
│  ├─ 应用     │  │ ☑ [严重] 数据库连接池耗尽 │ DB-01  │ 10:32││
│  ├─ 服务器   │  │ □ [重要] 磁盘使用率95%    │ SRV-02 │ 09:15││
│  ├─ 数据库   │  │ □ [严重] API响应超时      │ API-01 │ 08:20││
│  ├─ 中间件   │  │ ...                                          ││
│  ├─ 网络设备 │  └──────────────────────────────────────────────┘│
│  └─ 存储     │  共 88 条   页码: 1 / 5                           │
│              │                                                    │
│  业务系统    │  [当点击某条告警时，右侧弹出详情抽屉]              │
│  ├─ 统一支付 │                                                    │
│  ├─ 身份认证 │                                                    │
│  └─ 统一客服 │                                                    │
└──────────────┴──────────────────────────────────────────────────┘
```

### 3.2 告警详情抽屉

```
┌─────────────────────────────────────────────────────────────────┐
│ 告警详情                                           [关闭] [指派] │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ 【基本信息】                                                      │
│ 告警名称：数据库连接池耗尽                                        │
│ 告警等级：严重 [红色]                                             │
│ 告警状态：未处理                                                  │
│ 资源名称：mysql-prod-01                                          │
│ 资源类型：MySQL数据库                                             │
│ 所属系统：统一支付系统                                            │
│ 监控源：  Zabbix                                                  │
│                                                                   │
│ 【告警详情】                                                      │
│ 首次告警：2023-07-16 10:32:15                                    │
│ 最近告警：2023-07-16 10:45:22                                    │
│ 告警次数：8次                                                     │
│ 告警描述：                                                        │
│ MySQL连接池使用率达到100%，无法建立新连接。当前活跃连接数：      │
│ 200/200，等待队列长度：35。                                      │
│                                                                   │
│ 【当前指标】                                                      │
│ • 连接池使用率：100%                                              │
│ • 活跃连接数：200                                                 │
│ • 等待队列：35                                                    │
│ • 错误率：12.3%                                                   │
│                                                                   │
│ 【处理记录】                                                      │
│ 2023-07-16 10:35  王五  标记为处理中                             │
│   "正在排查，初步判断是连接未正常释放"                            │
│                                                                   │
│ 2023-07-16 10:40  王五  添加备注                                 │
│   "已重启应用，观察中"                                            │
│                                                                   │
│ 【操作】                                                          │
│ [指派给他人]  [标记已处理]  [关闭告警]  [添加备注]              │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 核心功能设计

### 4.1 资源目录树

**设计目标**: 多维度组织告警，快速定位目标告警

**树形结构**:

**第一层 - 监控源**:
```
监控源 (88条)
├─ Zabbix (56条)
├─ Prometheus (24条)
└─ 云监控 (8条)
```

**第二层 - 资源类型**:
```
资源类型 (88条)
├─ 应用 (12条)
├─ 服务器 (28条)
├─ 数据库 (18条)
├─ 中间件 (10条)
├─ 网络设备 (8条)
└─ 存储 (12条)
```

**第三层 - 业务系统**:
```
业务系统 (88条)
├─ 统一支付系统 (23条)
├─ 身份认证系统 (18条)
├─ 统一客服系统 (15条)
└─ ... 其他系统
```

**交互设计**:
- **复选框选择**: 勾选某个分类，右侧列表只显示该分类的告警
- **多选组合**: 可以同时勾选多个分类（如：服务器 + 数据库）
- **全部/取消**: 每个分组有"全部"和"取消"快捷按钮
- **数量徽章**: 每个节点显示告警数量徽章，红色表示有严重告警

**筛选逻辑**:
- 未选择任何节点：显示全部告警
- 选择单个节点：只显示该分类的告警
- 选择多个节点：显示所有选中分类的告警（OR逻辑）
- 跨层级选择：Zabbix + 数据库 → 显示Zabbix监控的数据库告警（AND逻辑）

**默认状态**:
- 初始加载时，不勾选任何节点
- 展开第一层"监控源"
- 其他分组折叠

### 4.2 快速筛选器

**设计目标**: 提供最常用的筛选维度，一键快速筛选

**等级筛选**（标签式）:
```
[严重 23] [重要 45] [次要 12] [提示 8]
```
- 显示格式：等级名称 + 数量
- 颜色编码：严重（红）、重要（橙）、次要（黄）、提示（蓝）
- 交互：点击切换选中状态，支持多选
- 选中样式：填充背景色，边框加粗

**状态筛选**（标签式）:
```
[未处理 56] [处理中 18] [已处理 14]
```
- 显示格式：状态名称 + 数量
- 颜色编码：未处理（红）、处理中（黄）、已处理（绿）
- 交互：点击切换选中状态，支持多选
- 选中样式：填充背景色，边框加粗

**实时统计**:
- 数量实时更新，反映当前筛选结果
- 如果某个等级/状态为0，标签置灰但仍可点击

**与资源树的联动**:
- 快速筛选和资源树筛选是AND关系
- 例如：选中"数据库" + "严重" → 显示数据库的严重告警

### 4.3 时间范围选择

**设计目标**: 查看特定时间段的告警

**时间选择器**:
- 组件：Ant Design DatePicker.RangePicker
- 默认值：最近24小时
- 常用快捷选项：
  - 最近1小时
  - 最近4小时
  - 最近24小时
  - 最近7天
  - 自定义范围

**时间筛选逻辑**:
- 按"首次告警时间"筛选
- 不是按"最近告警时间"（避免遗漏早期告警）

**交互设计**:
- 选择时间范围后，自动触发查询
- 显示加载动画
- 列表更新，显示匹配的告警

### 4.4 自动刷新

**设计目标**: 自动获取最新告警，减少手动刷新

**刷新控制**:
- 开关按钮：ON/OFF切换
- 刷新间隔：10秒/30秒/60秒可选
- 默认值：ON，30秒

**刷新行为**:
- 刷新时保持当前筛选条件
- 新增告警高亮显示（3秒后恢复）
- 刷新时不打断用户正在查看的详情抽屉

**暂停逻辑**:
- 用户正在编辑（指派、添加备注）时暂停刷新
- 用户离开页面（切换标签页）时暂停刷新
- 用户回到页面时恢复刷新

**刷新指示器**:
- 显示倒计时："下次刷新: 25秒"
- 刷新中显示加载动画
- 刷新成功后显示时间："最后更新: 10:45:22"

### 4.5 告警列表

**设计目标**: 清晰展示告警信息，支持快速操作

**列配置**:
- 复选框：支持多选
- 等级：标签形式，颜色编码
- 告警名称：粗体显示，可点击查看详情
- 资源名称：显示资源类型图标 + 名称
- 所属系统：灰色文字
- 首次告警时间：相对时间（1小时前）+ 绝对时间（tooltip）
- 告警次数：次数徽章
- 状态：标签形式，颜色编码
- 操作：指派、关闭快捷按钮

**排序**:
- 默认：按首次告警时间倒序（最新的在上）
- 支持列排序：等级、时间、次数
- 等级排序：严重 → 重要 → 次要 → 提示

**行样式**:
- 严重告警：浅红色背景
- 未处理告警：粗体字
- 已处理告警：半透明
- 悬停：浅蓝色背景

**分页**:
- 每页20条（可选10/20/50/100）
- 显示总数和页码
- 支持快速跳转

### 4.6 告警详情

**设计目标**: 提供告警的完整信息和处理入口

**信息分组**:

**基本信息**:
- 告警名称、等级、状态
- 资源名称、类型、所属系统
- 监控源

**告警详情**:
- 首次告警时间
- 最近告警时间
- 告警次数
- 详细描述（支持多行文本）

**当前指标**:
- 列表展示关键指标
- 实时数据，每10秒更新
- 异常指标红色高亮

**处理记录**:
- 时间轴展示处理过程
- 显示操作人、操作类型、备注
- 支持展开/折叠

**操作按钮**:
- 指派给他人：弹出指派表单
- 标记已处理：更新状态
- 关闭告警：填写关闭原因
- 添加备注：快速添加备注

**扩展功能**:
- 查看关联告警：同一资源的其他告警
- 查看监控图表：跳转到监控系统查看趋势
- 查看资产详情：跳转到资产管理页面

### 4.7 批量操作

**设计目标**: 提高处理效率，支持批量处理告警

**批量操作按钮**:
- 位置：列表上方，勾选后显示
- 显示格式："已选择 5 项"
- 操作选项：
  - 批量指派：统一指派给某人
  - 批量关闭：统一关闭并填写原因
  - 批量导出：导出到Excel
  - 批量标记：统一更改状态

**批量指派**:
```
1. 勾选多条告警
   ↓
2. 点击"批量指派"
   ↓
3. 弹出表单：
   • 指派给：[下拉选择]
   • 处理说明：[文本框]
   ↓
4. 提交
   ↓
5. 批量更新告警状态
   ↓
6. 显示成功提示："已指派 5 条告警"
```

**批量关闭**:
```
1. 勾选多条告警
   ↓
2. 点击"批量关闭"
   ↓
3. 弹出确认框：
   • 警告："确定关闭 5 条告警？"
   • 关闭原因：[文本框，必填]
   ↓
4. 确认
   ↓
5. 批量更新状态为"已关闭"
   ↓
6. 列表刷新，已关闭告警置灰
```

**批量限制**:
- 单次最多100条（防止误操作）
- 跨页选择：支持"全选所有页"
- 混合操作：如果选中的告警状态不一致，提示用户

---

## 5. 数据设计

### 5.1 告警数据模型（逻辑层面）

**告警记录表（AlertRecord）**:
- id: 唯一标识
- name: 告警名称
- level: 告警等级（严重/重要/次要/提示）
- status: 处理状态（未处理/处理中/已处理/已关闭）
- source: 监控源（Zabbix/Prometheus/云监控）
- resourceId: 关联资源ID
- resourceName: 资源名称
- resourceType: 资源类型
- systemId: 所属业务系统ID
- systemName: 业务系统名称
- firstOccurTime: 首次告警时间
- lastOccurTime: 最近告警时间
- occurCount: 告警次数
- description: 告警描述
- currentMetrics: 当前指标（JSON）
- assignee: 当前处理人
- createTime: 创建时间
- updateTime: 更新时间

**告警处理记录表（AlertHandleRecord）**:
- id: 唯一标识
- alertId: 告警ID（外键）
- handleType: 处理类型（指派/标记/关闭/备注）
- handleTime: 处理时间
- handler: 处理人
- content: 处理内容
- createTime: 创建时间

**告警统计表（AlertStatistics）**:
- id: 唯一标识
- statisticsDate: 统计日期
- totalCount: 总告警数
- criticalCount: 严重告警数
- importantCount: 重要告警数
- minorCount: 次要告警数
- infoCount: 提示告警数
- unresolvedCount: 未处理数
- processingCount: 处理中数
- resolvedCount: 已处理数
- avgResolveTime: 平均处理时长（分钟）

### 5.2 数据流转

```
页面加载
    ↓
1. 加载资源目录树数据
   • 查询监控源分类及数量
   • 查询资源类型分类及数量
   • 查询业务系统分类及数量
    ↓
2. 加载快速筛选器数据
   • 统计各等级告警数量
   • 统计各状态告警数量
    ↓
3. 加载告警列表（默认条件）
   • 时间范围：最近24小时
   • 排序：首次告警时间倒序
   • 分页：第1页，每页20条
    ↓
4. 渲染页面
    ↓
5. 启动自动刷新定时器（如果开启）
```

**筛选数据流转**:
```
用户操作筛选器
    ↓
1. 收集筛选条件：
   • 资源树勾选项
   • 快速筛选标签
   • 时间范围
    ↓
2. 组合查询条件（AND逻辑）
    ↓
3. 查询后端API
    ↓
4. 更新列表和统计数据
    ↓
5. 更新URL参数（便于分享链接）
```

---

## 6. 交互设计

### 6.1 筛选交互流程

**多维度筛选组合**:
```
场景：查找数据库相关的严重告警

1. 用户勾选"数据库"分类
   ↓
   列表显示所有数据库告警（56条）
   ↓
2. 用户点击"严重"标签
   ↓
   列表只显示数据库的严重告警（8条）
   ↓
3. 用户调整时间范围为"最近1小时"
   ↓
   列表只显示1小时内数据库的严重告警（2条）
```

**清空筛选**:
- 提供"清空筛选"按钮
- 点击后恢复默认状态
- 保留时间范围（不重置）

### 6.2 告警处理流程

**指派流程**:
```
1. 点击告警行的"指派"按钮
   ↓
2. 弹出指派表单
   • 指派给：[下拉选择人员]
   • 处理说明：[文本框]
   • 预计完成时间：[日期选择器，可选]
   ↓
3. 填写并提交
   ↓
4. 更新告警状态为"处理中"
   ↓
5. 创建处理记录
   ↓
6. 发送通知给被指派人
   ↓
7. 列表刷新，告警行变为黄色（处理中）
```

**关闭流程**:
```
1. 点击"关闭告警"按钮
   ↓
2. 弹出确认对话框
   • 警告："确定关闭此告警？"
   • 关闭原因：[文本框，必填]
   ↓
3. 填写原因并确认
   ↓
4. 更新状态为"已关闭"
   ↓
5. 创建处理记录
   ↓
6. 列表刷新，告警行置灰
```

### 6.3 自动刷新交互

**刷新中的交互**:
- 刷新时列表顶部显示进度条
- 不影响用户滚动浏览
- 不关闭已打开的详情抽屉

**新告警提示**:
```
自动刷新发现新告警
    ↓
1. 新告警插入到列表顶部
   ↓
2. 行背景闪烁3次（黄色高亮）
   ↓
3. 页面顶部显示提示："新增 3 条告警"
   ↓
4. 3秒后提示消失
```

---

## 7. 架构设计决策

### 7.1 为什么使用三分类资源树？

**决策**: 监控源、资源类型、业务系统三个独立分类

**原因**:
1. **多视角**: 不同角色关注不同维度
   - 监控运维关注监控源
   - 系统运维关注资源类型
   - 业务团队关注业务系统
2. **灵活组合**: 支持跨维度筛选（如：Zabbix的数据库告警）
3. **清晰层次**: 三个分类互不从属，避免层级过深

**对比方案**:
- 单一树形结构（系统 → 资源 → 告警）：层级深，展开麻烦
- 平铺列表：没有分类，信息过载

### 7.2 为什么使用标签式快速筛选？

**决策**: 等级和状态使用标签按钮，而非下拉框

**原因**:
1. **可见性**: 所有选项一览无余，不用点开才看到
2. **实时统计**: 标签上显示数量，帮助用户判断
3. **多选便利**: 点击切换比下拉多选更快
4. **视觉突出**: 彩色标签比文字列表更醒目

**何时用下拉框**:
- 选项超过10个（如：选择指派人员）
- 选项是动态的（如：搜索过滤）

### 7.3 为什么支持自动刷新？

**决策**: 提供自动刷新开关和间隔设置

**原因**:
1. **实时性要求**: 告警需要及时发现和处理
2. **减少操作**: 避免手动刷新的繁琐
3. **用户控制**: 开关和间隔可调，不强制

**实现考虑**:
- 使用轮询而非WebSocket（简单可靠）
- 刷新时保持筛选条件
- 智能暂停（用户交互时不刷新）

### 7.4 为什么告警详情用抽屉而非模态框？

**决策**: 点击告警弹出右侧抽屉，而非居中模态框

**原因**:
1. **不遮挡列表**: 抽屉打开时仍可看到列表，便于对比
2. **空间利用**: 抽屉可以更宽，展示更多内容
3. **操作连贯**: 可以快速切换查看多个告警
4. **现代体验**: 抽屉是B端产品的流行选择

---

## 8. 视觉设计

### 8.1 告警等级颜色

**颜色定义**:
- 🔴 严重：#ff4d4f（亮红）- 需要立即处理
- 🟠 重要：#fa8c16（橙色）- 优先处理
- 🟡 次要：#faad14（黄色）- 正常处理
- 🔵 提示：#1890ff（蓝色）- 参考信息

**应用场景**:
- 标签背景色
- 列表行背景色（严重告警浅红底）
- 徽章颜色
- 快速筛选标签

### 8.2 告警状态颜色

**颜色定义**:
- 🔴 未处理：#ff4d4f（红色）- 需要关注
- 🟡 处理中：#faad14（黄色）- 进行中
- 🟢 已处理：#52c41a（绿色）- 已完成
- ⚪ 已关闭：#8c8c8c（灰色）- 已归档

### 8.3 列表行样式

**严重告警特殊样式**:
- 背景：rgba(255, 77, 79, 0.1) 浅红色
- 左边框：4px 红色实线
- 告警名称：粗体

**普通告警**:
- 背景：白色
- 悬停：浅蓝色背景

**已处理告警**:
- 背景：白色
- 透明度：0.6
- 文字：灰色

---

## 9. 扩展性设计

### 9.1 功能扩展

**当前功能**: 查看、筛选、指派、关闭

**扩展方向**:
1. **告警聚合**: 相同告警自动聚合，减少噪音
2. **告警抑制**: 配置抑制规则，某些情况下不产生告警
3. **值班排班**: 告警自动分配给当前值班人
4. **告警升级**: 超时未处理自动升级给上级
5. **根因分析**: 自动分析告警根本原因
6. **告警预测**: 基于历史预测可能的告警
7. **移动端推送**: 严重告警推送到手机APP

### 9.2 统计分析

**当前**: 简单的数量统计

**扩展方向**:
1. **趋势图表**: 告警数量随时间变化趋势
2. **TOP排行**: 告警最多的资源、系统、监控源
3. **处理效率**: 平均处理时长、处理率
4. **值班报表**: 每个值班人员的处理统计
5. **告警质量**: 误报率、重复告警率

### 9.3 智能化

**扩展方向**:
1. **智能分类**: 自动识别告警类型和优先级
2. **智能推荐**: 推荐类似告警的处理方案
3. **智能指派**: 根据技能和负载自动指派
4. **智能降噪**: 机器学习识别无效告警

---

## 10. 性能考虑

### 10.1 大数据量处理

**场景**: 系统每天产生10000+条告警

**优化策略**:
1. 默认只查最近24小时的告警
2. 列表分页，每页不超过100条
3. 后端索引优化（时间、等级、状态复合索引）
4. 前端虚拟滚动（大列表时）
5. 告警自动归档（超过30天的自动归档）

### 10.2 自动刷新优化

**优化策略**:
1. 增量刷新，只获取最新数据
2. 长时间无操作自动暂停刷新
3. 网络异常时自动降低刷新频率
4. 刷新时使用防抖，避免重复请求

### 10.3 筛选性能

**优化策略**:
1. 筛选条件变化时防抖500ms再查询
2. 前端缓存已查询的数据
3. 后端查询超时设置为5秒
4. 复杂筛选使用后台任务，异步返回结果

---

## 11. 后续优化方向

### 11.1 协同增强

1. **评论功能**: 告警下支持多人讨论
2. **关联工单**: 创建工单处理告警
3. **知识库**: 关联历史处理方案
4. **团队看板**: 可视化展示团队告警处理进度

### 11.2 用户体验

1. **自定义视图**: 保存常用的筛选组合
2. **订阅通知**: 订阅特定类型的告警通知
3. **键盘快捷键**: J/K导航，Enter查看详情
4. **深色模式**: 支持夜间值班模式

### 11.3 集成扩展

1. **IM集成**: 告警推送到钉钉、企业微信
2. **ITSM集成**: 与ITSM系统联动
3. **CMDB集成**: 从CMDB获取资源信息
4. **监控系统直连**: 查看实时监控图表

---

**文档版本**: v1.0
**最后更新**: 2025-10-15
**维护者**: Claude Code Assistant
