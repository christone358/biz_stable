# 产品需求文档（PRD）— 通用工单详情与处理历史（桌面端）

文档信息
- 文档版本：v1.0
- 适用端：桌面端（不含移动端）
- 面向读者：研发人员（前端、后端、测试、产品/交互）
- 非范围：实现方案、接口细节、移动端交互、即时讨论与 @ 能力

---

## 一、背景与目标
- 背景：本系统作为一体化流程平台的子系统节点，承接流程中的“协同办理”类工单。用户在本系统内完成办理/退回/移交，并回馈办理结果与数据。
- 目标
  - 信息优先：工单关键信息“开页即知”，字段与结构稳定、可检索。
  - 单一入口：右侧操作区为唯一操作入口，先选“处理模式”，再填写对应信息并提交。
  - 动态适配：办理模式支持按业务类型切换“动态表单”，不同事项展示/校验不同字段。
  - 留痕完整：所有办理/退回/移交形成历史记录，便于追溯与审计。
- 成功标准（体验导向）
  - ≥95% 操作在右侧完成；无需滚动查找其他入口
  - 办理提交失败后，错误字段定位时间 ≤ 3 秒
  - 历史记录可完整还原每次办理（含备注、附件）

---

## 二、术语与角色
- 工单：承载一次流程在本系统的办理任务
- 办理：在本节点按业务要求填写并提交办理结果数据
- 退回：将工单退回至历史节点，附原因与可选佐证
- 移交：指派/转派至其他人员/角色/组织继续办理
- 角色：办理人、审核人（如存在审批节点）、发起人（只读）

---

## 三、范围与导航
- 页面：工单详情页（默认 Tab）｜处理历史页（独立 Tab）
- 布局（工单详情页）：
  - 顶部 Summary Bar（吸顶、简洁）
  - 左侧详情区（约 16 栅格）：事项概要（固定）→（如需）上下文只读信息 → 附件（固定）
  - 右侧操作区（约 8 栅格，粘性常驻）：处理模式选择＋模式表单＋备注与附件＋提交区
- 单一入口：右侧操作区。底部不再提供吸底操作条；无其他入口

---

## 四、页面信息结构与确定字段（工单详情页）

### 4.1 顶部 Summary Bar（确定字段）
- 主题（subject）
  - 展示：文本（建议 24 字以内）；按权限可编辑/只读
  - 取值：中文/数字/字母/常见符号，不含换行；长度 1–100 字符（显示截断 + 悬浮完整）
- 工单号（ticketNo）
  - 展示：只读；提供“复制”动作
  - 取值：统一格式（如 TKT-YYYYMMDD-XXXX）；全局唯一
- 状态（status）
  - 展示：Tag（颜色规则见第七章）
  - 取值：draft｜processing｜returned｜on_hold｜resolved｜closed｜canceled
- 优先级（priority）
  - 展示：Tag
  - 取值：P0（紧急）｜P1（高）｜P2（中）｜P3（低）

### 4.2 事项概要（固定区，确定字段）
- 字段（只读，除主题按权限可能可编辑）
  - 工单号（与 Summary 一致）
  - 创建时间（createdAt）：YYYY-MM-DD HH:mm；系统统一时区
  - 发起人（creator）：显示姓名；必要时展示工号/账号
  - 业务系统（businessSystem）：
    - 一级系统（level1）：单选；从“系统目录字典”选取
    - 二级系统（level2）：单选；与一级联动（无则显示“—”）
- 缺失值展示：统一显示“—”

### 4.3 附件（固定区，确定能力）
- 能力：上传、预览、下载、删除（按权限）
- 取值范围（可配置）
  - 文件类型：pdf、doc、docx、xls、xlsx、csv、png、jpg、jpeg、txt、zip
  - 单文件大小 ≤ 50MB；单次最多 20 个；工单总量上限 100 个
- 交互：拖拽/点击上传；图片/文档在线预览；其他类型下载
- 说明：右侧模式表单内仅“引用”已上传文件；新增文件需先在此区上传

---

## 五、右侧操作区（唯一入口）

### 5.1 顶层交互：处理模式选择
- 控件：Segmented/Tabs（三选一）：【办理｜退回｜移交】
- 默认选项：
  - 节点为“办理”性质：默认【办理】
  - 节点仅允许退回/移交：默认可用模式中的首项
- 切换保护：当前模式存在未保存改动时，弹出确认（保存草稿｜放弃改动｜取消切换）

### 5.2 三类模式的通用附加区
- 备注（remark）：多行文本，0–1000 字；粘贴纯文本
- 附件（modeAttachments）：引用“附件区”已上传文件；弹窗内不重复上传

### 5.3 模式一：办理（动态表单）
- 目的：回填办理结果数据；字段随业务类型变化
- 表单容器：在右侧操作区中部呈现；仅在“办理模式”下显示
- 模块类型与展示要求：
  1) FormGrid（N 列 M 行）
     - 列数：1/2 列（右侧宽度受限，不使用 3 列及以上）
     - 字段类型：文本、数字、金额、日期/时间、开关、枚举（单/多选）、成员/组织选择、IP/端口、CIDR、只读文本、轻量富文本
     - 规则：必填、长度、范围、格式、唯一性；可见/只读/默认值的条件表达式
  2) DataTable（明细表）
     - 行为：新增/删除/行内编辑；行级校验；（批量导入为可选 V2）
     - 列类型：同 FormGrid；状态列枚举：pending｜success｜failed｜skipped｜rolled_back
     - 规则：当 status∈{failed,skipped,rolled_back} 时“原因”必填；至少 1 行（可配置）
  3) RepeatableGroup（可重复子表单/卡片）
     - 规则：最少/最多条数可配置；每条为小型 FormGrid
- 提交规则：
  - 保存草稿：保存当前办理表单 + 通用附加区；不做强校验
  - 提交：仅对【办理动态表单模块】做强校验；校验通过后提交并生成一次“办理记录”
  - 允许“结果=部分”：当存在失败/跳过条目时

### 5.4 模式二：退回（轻量参数）
- 字段：
  - 目标节点（targetNode）：必填；从历史节点选择（显示“节点名｜到达时间｜处理人”）
  - 退回原因（returnReason）：必填；1–500 字
  - 备注、附件引用：可选
- 行为：提交（强校验必填项）；保存草稿（可选）

### 5.5 模式三：移交（指派/转派，轻量参数）
- 字段：
  - 移交对象（assignees）：必填；人员/角色/组织（单/多选）；可搜索；显示“姓名｜组织”
  - 移交说明（handoverNote）：0–300 字
  - 备注、附件引用：可选
- 行为：提交（强校验对象）；保存草稿（可选）

---

## 六、处理历史页（独立 Tab）

### 6.1 过滤与概览
- 过滤项：时间范围（YYYY-MM-DD）｜动作类型（办理结果/退回/移交/草稿保存/系统事件）｜办理结果（成功/失败/部分，仅对办理记录）｜操作人｜关键词
- 概览指标（可选）：总记录数、办理次数、退回次数、移交次数、最近一次办理时间

### 6.2 展示结构
- 时间线（倒序）：时间｜类型｜操作人｜摘要（如“办理结果：成功（成功 N/失败 M）”）｜【查看详情】
- 记录列表（可展开）：
  - 列：时间｜类型｜操作人｜结果/结论｜明细条数｜附件数｜【展开】
  - 展开内容：
    - 办理结果：摘要（成功/失败/部分）、关键指标（成功/失败条目数等）、明细表（目标/动作/状态/原因/执行人/时间）、备注与附件
    - 退回：目标节点、退回原因、备注与附件
    - 移交：目标对象（人/角色/组织）、说明、备注与附件

---

## 七、统一展示与取值规范

### 7.1 状态与优先级（Tag 颜色建议）
- 状态：
  - draft（灰）｜processing（蓝）｜returned（橙）｜on_hold（紫）｜resolved（绿）｜closed（绿/灰）｜canceled（红）
- 优先级：
  - P0（红）｜P1（橙）｜P2（蓝）｜P3（灰）

### 7.2 字段通用规范
- 时间：YYYY-MM-DD HH:mm；统一时区
- 文本：超长截断 + 悬浮完整；过滤脚本执行字符
- IP/端口/CIDR：格式校验准确；错误就地提示
- 选择器：支持搜索；二级从属于一级；空值显示“—”
- 备注：最多 1000 字；退回原因最多 500 字；移交说明最多 300 字

### 7.3 校验与提示
- 位置：字段下方就地提示（红色）
- 提交失败：在右侧操作区内自动滚动定位首个错误字段
- 草稿：允许保存不完整内容；成功提示“草稿已更新”

---

## 八、权限与显隐（产品规则）
- 办理模式：编辑/提交权限可分离；无提交权限时隐藏“提交”但可编辑并保存草稿（按配置）
- 退回/移交：需对应权限才显示该模式
- 模式默认选择：依据节点类型（办理/审批）与权限计算
- 字段级可见性：办理动态表单字段支持“可见/只读/必填”的条件表达式

---

## 九、动态表单逻辑与展示要求（办理模式）
- 模板归属：由“业务类型”确定（如：安全加固、策略开通…）
- 模板结构：包含若干“模块”，模块类型为 FormGrid / DataTable / RepeatableGroup
- 模块定义：标题、字段/列、校验规则、是否必填、最小/最大条数
- 字段类型（建议集）：文本（单/多行）、数字/金额、布尔开关、日期/时间、枚举（单/多选）、成员/组织选择、IP/端口/CIDR、只读文本、轻量富文本
- 条目状态枚举（DataTable）：pending｜success｜failed｜skipped｜rolled_back
  - 当 status∈{failed,skipped,rolled_back} 时，“原因”必填
- 布局与可读性：在右侧宽度下 FormGrid 仅用 1–2 列；按重要度排序；模块可折叠（默认展开首个）
- 提交范围：仅校验办理模块；不校验概要与附件固定区
- 结果允许“部分”：当存在失败/跳过条目时
- 办理记录摘要：outcome（成功/失败/部分）、metrics（总条目/成功/失败…）、items 概要

---

## 十、非功能与体验要求
- 性能：右侧表单在模块较多时需分组/折叠；表格支持分页或虚拟滚动（保持流畅）
- 可访问性：键盘可达；控件聚焦边界清晰
- 空态：无历史记录时显示引导文案；无附件显示占位

---

## 十一、边界与不做
- 不提供即时讨论/@
- 不在顶部展示来源系统、截止时间、SLA 倒计时
- 不在详情页底部展示流程进度（进度/历史迁至“处理历史” Tab）
- 不提供移动端适配

---

## 十二、验收要点（体验导向）
- 右侧为唯一操作入口，三类模式切换清晰；未保存改动时切换有确认
- 办理模式可按业务类型展示不同字段；提交仅校验办理模块；失败能在 3 秒内定位首个错误
- 三类模式均支持备注与附件引用；提交后在处理历史中形成完整记录
- 附件区固定、可上传预览下载；右侧仅引用附件，不重复上传
- 处理历史页过滤 + 时间线 + 列表一致呈现；记录内容完整

---

## 十三、开放问题
- 业务类型模板的管理策略（版本、灰度、回滚）
- 退回/移交是否允许多目标的并行指派（人/组织混合）
- 处理历史的“版本对比”能力是否纳入本期（建议 V2）

---

### 附录 A：字段字典（确定值域）
- status：draft｜processing｜returned｜on_hold｜resolved｜closed｜canceled
- priority：P0｜P1｜P2｜P3
- outcome（办理结果）：success｜failed｜partial
- dataItem.status：pending｜success｜failed｜skipped｜rolled_back
