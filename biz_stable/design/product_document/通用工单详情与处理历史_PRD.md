# 产品需求文档（PRD）— 通用工单详情与处理历史（桌面端）

文档信息
- 文档版本：v1.1
- 适用端：桌面端（不含移动端）
- 面向读者：研发人员（前端、后端、测试、产品/交互）
- 非范围：实现方案、接口细节、移动端交互、即时讨论与 @ 能力

修订记录（v1.1）
- 将“申请信息”等 FormGrid 模块的呈现样式统一为与“事项概要信息”一致的双列信息行样式
- “访问用户明细列表”等明细模块统一以单张表格呈现，取消每条数据单独 KV 卡片的样式

---

## 一、背景与目标
- 背景：本系统作为一体化流程平台的子系统节点，承接流程中的“协同办理”类工单。用户在本系统内完成办理/退回/移交，并回馈办理结果与数据。
- 目标
  - 信息优先：工单关键信息“开页即知”，字段与结构稳定、可检索。
  - 单一入口：右侧操作区为唯一操作入口，先选“处理模式”，再填写对应信息并提交。
  - 动态适配：办理模式支持按业务类型切换“动态表单”，不同事项展示/校验不同字段。
  - 留痕完整：所有办理/退回/移交形成历史记录，便于追溯与审计。
- 成功标准（体验导向）
  - ≥95% 操作在右侧完成；无需滚动查找其他入口
  - 办理提交失败后，错误字段定位时间 ≤ 3 秒
  - 历史记录可完整还原每次办理（含备注、附件）

---

## 二、术语与角色
- 工单：承载一次流程在本系统的办理任务
- 办理：在本节点按业务要求填写并提交办理结果数据
- 退回：将工单退回至历史节点，附原因与可选佐证
- 移交：指派/转派至其他人员/角色/组织继续办理
- 角色：办理人、审核人（如存在审批节点）、发起人（只读）

---

## 三、范围与导航
- 页面：工单详情页（默认 Tab）｜处理历史页（独立 Tab）
- 布局（工单详情页）：
  - 顶部 Summary Bar（吸顶、简洁）
  - 左侧详情区（约 16 栅格）：事项概要（固定）→（如需）上下文只读信息 → 附件（固定）
  - 右侧操作区（约 8 栅格，粘性常驻）：处理模式选择＋模式表单＋备注与附件＋提交区
- 单一入口：右侧操作区。底部不再提供吸底操作条；无其他入口

页面元素布局结构（详情页）
- Summary Bar：展示标题、编号、状态、优先级；与详情区视觉分隔
- 详情卡片：
  - 分区顺序固定：
    1) 事项概要信息（固定字段）
    2) 任务明细信息（动态模块，含“申请信息”“设备/用户明细”等）
    3) 附件信息（固定能力）
  - 视觉一致性：详情区所有只读信息采用统一信息行样式；其中“申请信息”等结构化字段与“事项概要信息”保持完全一致的标签与对齐规范
- 操作区（唯一入口）：顶部为模式选择，其下为对应模式表单/参数与动作区

---

## 四、页面信息结构与确定字段（工单详情页）

### 4.1 顶部 Summary Bar（确定字段）
- 主题（subject）
  - 展示：文本（建议 24 字以内）；按权限可编辑/只读
  - 取值：中文/数字/字母/常见符号，不含换行；长度 1–100 字符（显示截断 + 悬浮完整）
- 工单号（ticketNo）
  - 展示：只读；提供“复制”动作
  - 取值：统一格式（如 TKT-YYYYMMDD-XXXX）；全局唯一
- 状态（status）
  - 展示：Tag（颜色规则见第七章）
  - 取值：draft｜processing｜returned｜on_hold｜resolved｜closed｜canceled
- 优先级（priority）
  - 展示：Tag
  - 取值：P0（紧急）｜P1（高）｜P2（中）｜P3（低）

### 4.2 事项概要（固定区，确定字段）
- 字段（只读，除主题按权限可能可编辑）
  - 工单号（与 Summary 一致）
  - 创建时间（createdAt）：YYYY-MM-DD HH:mm；系统统一时区
  - 发起人（creator）：显示姓名；必要时展示工号/账号
  - 业务系统（businessSystem）：
    - 一级系统（level1）：单选；从“系统目录字典”选取
    - 二级系统（level2）：单选；与一级联动（无则显示“—”）
- 缺失值展示：统一显示“—”

### 4.3 详细信息（动态区，依模板渲染）
- 定位：位于“事项概要”下方，使用同一体卡片，仅通过分组标题区分
- 模块类型：
  1. FormGrid（结构化字段区）
     - 适用场景：申请信息、核心参数、配置项等字段型信息
     - 展示样式：与“事项概要信息”一致的双列信息行样式（标签与内容左右排列，标签固定宽度，对齐一致）；不使用逐行边框卡片样式
     - 列数：优先 2 列；窄屏降级为 1 列；字段间距与概要区保持一致
     - 取值来源：来自工单发起时提交的数据；只读呈现；空值统一显示“—”
  2. DataTable（明细列表区）
     - 适用场景：访问用户明细列表、设备/账户明细、整改项等多行数据
     - 展示样式：整模块使用一张表格统一呈现；禁止将每条数据拆分为多个 KV 卡片或多张小表
     - 列要求：至少 3 列；列标题清晰、单位/口径明确；列宽按内容自适应，必要时支持横向滚动
     - 行数据：来自明细数据集合；空数据时展示统一空态文案“暂无数据”
- 模块装配：每个工单模板可配置 0~N 个 FormGrid + DataTable，顺序可控；默认展开全部
- 空态：当模块无数据时展示“暂无提交信息”，不渲染空列

### 4.4 附件（固定区，确定能力）
- 能力：上传、预览、下载、删除（按权限）
- 取值范围（可配置）
  - 文件类型：pdf、doc、docx、xls、xlsx、csv、png、jpg、jpeg、txt、zip
  - 单文件大小 ≤ 50MB；单次最多 20 个；工单总量上限 100 个
- 交互：拖拽/点击上传；图片/文档在线预览；其他类型下载
- 说明：右侧模式表单内仅“引用”已上传文件；新增文件需先在此区上传

### 4.5 呈现与交互规则（详情区）
- 渲染顺序：事项概要信息 → 任务明细信息（依模板顺序渲染所有模块）→ 附件信息
- 视觉一致性：
  - “申请信息”等 FormGrid 模块的行高、间距、标签宽度与“事项概要信息”保持一致
  - 明细模块（如“访问用户明细列表”）以表格统一呈现，不拆分为多块 KV 卡片
- 空态与缺省值：
  - FormGrid：模块存在但无字段/无值时展示“暂无提交信息”；字段缺省显示“—”
  - DataTable：无行数据时展示“暂无数据”；不渲染空列
- 可读性：
  - 列宽按内容自适应；内容过多时允许横向滚动；单元格内文本溢出时悬浮显示完整
  - 分组标题清晰可见；模块默认展开，不提供折叠（如需变更，另行评估）

---

## 五、右侧操作区（唯一入口）

### 5.1 顶层交互：处理模式选择
- 控件：Segmented（四选一）：【审批｜操作｜转派｜无权限】
- 默认选项：
  - 默认以“当前节点性质与权限”决定；具备操作权限时默认【操作】；具备审批权限时可切换至【审批】。
- 切换保护：当前版本未实现“未保存改动提示”，切换直接生效。

### 5.2 通用元素（操作区）
- 任务评论：多行文本，0–1000 字；显示为“任务评论”；可选。
- 上传附件：直接在操作区上传后加入附件列表；支持多文件；与左侧“附件信息”共享同一附件集合。
- 说明：当前版本不提供“引用已上传附件”的单独选择器，直接上传即可。

### 5.3 模式一：审批
- 字段：审批结论（同意/驳回，必选）；审批意见（至少 5 个字，必填）。
- 提交：强校验上述字段，提交后形成一次审批记录。

### 5.4 模式二：操作（动态表单）
- 目的：填写工单类型对应的操作差异化字段。
- 表单容器：在右侧操作区中部呈现；仅在“操作”模式下显示。
- 模块类型与展示要求：
  1) FormGrid（1–2 列，小屏降级为 1 列）。
  2) DataTable（明细表，支持新增/删除/行内编辑，行级校验）。
  - 注：RepeatableGroup 暂未实现（V2 再评估）。
- 提交规则：仅对【操作动态表单模块】做强校验；允许部分成功（如存在失败/跳过条目）。

### 5.5 模式三：转派
- 字段：转派对象（人员/角色/组织，必选）；说明（0–300 字，可选）。
- 提交：强校验对象后提交。

### 5.6 模式四：无权限
- 展示只读提示；隐藏提交按钮，仅保留“任务评论/上传附件”。

---

## 六、处理历史页（独立 Tab）

### 6.1 过滤与概览
- 过滤项（当前实现未提供过滤器，V2 再评估）。
- 概览指标：不展示统计概览（V2 再评估）。

### 6.2 展示结构
- 时间线（倒序）：时间｜类型｜操作人｜摘要（如“审批：同意/驳回；操作：成功/失败/部分”等）。
- 列表视图：当前版本不提供“记录列表”展开视图，仅保留时间线（V2 再评估）。

---

## 七、统一展示与取值规范

### 7.1 状态与优先级（Tag 颜色建议）
- 状态：
  - draft（灰）｜processing（蓝）｜returned（橙）｜on_hold（紫）｜resolved（绿）｜closed（绿/灰）｜canceled（红）
- 优先级：
  - P0（红）｜P1（橙）｜P2（蓝）｜P3（灰）

### 7.2 字段通用规范
- 时间：YYYY-MM-DD HH:mm；统一时区
- 文本：超长截断 + 悬浮完整；过滤脚本执行字符
- IP/端口/CIDR：格式校验准确；错误就地提示
- 选择器：支持搜索；二级从属于一级；空值显示“—”
- 备注：最多 1000 字；退回原因最多 500 字；移交说明最多 300 字

### 7.3 校验与提示
- 位置：字段下方就地提示（红色）。
- 提交失败：在右侧操作区内自动滚动定位首个错误字段。
- 草稿：当前版本不支持保存草稿。

---

## 八、权限与显隐（产品规则）
- 审批/操作/转派：按权限显示对应模式；无权限时展示“无权限”。
- 无提交权限：隐藏“提交”按钮，但可填写“任务评论/上传附件”。
- 字段级可见性：操作动态表单字段支持“可见/只读/必填”的条件表达式。

---

## 九、动态表单逻辑与展示要求（操作模式）
- 模板归属：由“业务类型”确定（如：安全加固、策略开通…）
- 模板结构：包含若干“模块”，模块类型为 FormGrid / DataTable（RepeatableGroup 暂不支持）
- 模块定义：标题、字段/列、校验规则、是否必填、最小/最大条数
- 字段类型（建议集）：文本（单/多行）、数字/金额、布尔开关、日期/时间、枚举（单/多选）、成员/组织选择、IP/端口/CIDR、只读文本、轻量富文本
- 条目状态枚举（DataTable）：pending｜success｜failed｜skipped｜rolled_back
  - 当 status∈{failed,skipped,rolled_back} 时，“原因”必填
- 布局与可读性：在右侧宽度下 FormGrid 仅用 1–2 列；按重要度排序；模块可折叠（默认展开首个）
- 提交范围：仅校验办理模块；不校验概要与附件固定区
- 结果允许“部分”：当存在失败/跳过条目时
- 办理记录摘要：outcome（成功/失败/部分）、metrics（总条目/成功/失败…）、items 概要

---

## 十、非功能与体验要求
- 性能：右侧表单在模块较多时需分组/折叠；表格支持分页或虚拟滚动（保持流畅）
- 可访问性：键盘可达；控件聚焦边界清晰
- 空态：无历史记录时显示引导文案；无附件显示占位

---

## 十一、边界与不做
- 不提供即时讨论/@
- 不在顶部展示来源系统、截止时间、SLA 倒计时
- 不在详情页底部展示流程进度（进度/历史迁至“处理历史” Tab）
- 不提供移动端适配

---

## 十二、验收要点（体验导向）
- 右侧为唯一操作入口，三类模式切换清晰；未保存改动时切换有确认
- 办理模式可按业务类型展示不同字段；提交仅校验办理模块；失败能在 3 秒内定位首个错误
- 三类模式均支持备注与附件引用；提交后在处理历史中形成完整记录
- 附件区固定、可上传预览下载；右侧仅引用附件，不重复上传
- 处理历史页过滤 + 时间线 + 列表一致呈现；记录内容完整
- 详情区呈现：
  - “申请信息”等结构化字段与“事项概要信息”样式一致（双列信息行、统一标签宽度、无逐行边框卡片）
  - “访问用户明细列表”等多行数据以单张表格呈现，禁止每条数据拆成独立 KV 区块

---

## 十三、开放问题
- 业务类型模板的管理策略（版本、灰度、回滚）
- 退回/移交是否允许多目标的并行指派（人/组织混合）
- 处理历史的“版本对比”能力是否纳入本期（建议 V2）

---

## 十四、任务列表页（协同任务管理 / 任务中心）

### 14.1 页面目标与范围
- 目标：在统一的列表界面高效浏览、筛选、定位协同任务，快速进入工单详情进行办理。
- 范围：状态统计卡片区、筛选条、任务列表（行卡片），不含工单详情与历史页（见前文）。
 - 默认视图（个人视角）：进入系统或任务中心路由时，默认呈现“我的待办”（我负责的未完成任务）。状态默认包含“待处理｜处理中｜逾期”；任务类型默认“全部”。取消“任务类型”顶部 Tab，用筛选条件替代。

### 14.2 顶层分类（个人工单工作台）
- 分类：我的待办｜我提交的｜我的已办｜全部工单（卡片样式，参考 docs/1.png）
- 行为与口径：
  - 我的待办：当前处理人为我；状态=处置中（待处理｜处理中｜逾期）
  - 我提交的：发起人=我；状态默认=全部
  - 我的已办：我已完成的工单（status=completed 且当前处理人/责任人/发起人任一为我）；状态默认=已完成
  - 全部工单：全量；状态默认=全部
- 交互：点击卡片即切换范围并刷新列表与统计；选中态有高亮
- 响应式：四列→两列（≤1200px）

- 顶部状态统计卡片：取消（不再展示“全部任务｜处置中｜已完成｜已作废”卡片）。
- 筛选条：紧随顶层分类卡片下方，包含“状态（默认待办三态）｜任务类型（层级多选）｜时间范围｜关键词”等过滤器，并显示当前筛选摘要（可轻量展示处置中/已完成/已作废计数）。
- 任务列表：卡片式列表，每行一个任务；行内采用“主信息区（左） + 侧栏（右）”两段式。
- 移除元素：取消“任务类型”的顶部 Tab（如历史版本存在），统一改为筛选条件呈现。
- 新建入口：筛选行右侧提供“新建工单”按钮；点击后弹出“选择任务类型（安全加固/应急处置）”，确认后在新标签页打开新建页面（/collaboration/tickets/new?type=...）。

### 14.3 列表行信息结构
- 标题区（左侧首行）
  - Tag：优先级（P0/P1/P2/P3），在最左侧；仅此 Tag 与下一个类型 Tag 保留。
  - Tag：任务类型（运行告警/脆弱性/资产运营等）；紧随优先级 Tag。
  - 任务标题：加粗单行展示，超长截断，悬浮完整。不得夹带多余标签（如“网络异常/安全威胁/系统性能”等二级标签）

- 元信息区（左侧次行，使用“｜”分隔，自动换行）
  - 任务编号：可复制；显示格式如“TASK-202412-0001”。
  - 创建时间：显示“YYYY-MM-DD HH:mm（x小时前）”。
  - 流程发起人：显示人名；可附账号/工号作为次级信息（可选）。
  - 当前处理人：显示人名；未指派时显示“未指派”。
  - 时间字段：按业务规则二选一展示（位置固定在“当前处理人”之后）：
    - 完成状态：显示“完成时间：YYYY-MM-DD HH:mm”。
    - 非完成状态：显示“截止时间：YYYY-MM-DD HH:mm”，若剩余<24小时，追加“（剩余N小时）”；若已逾期，追加“（已逾期N小时/天）”。
  - 移除字段：不展示“责任单位”“上一环节审批人”“任务描述”“进度条”。

- 侧栏（右）
  - 处置状态 Tag：靠右对齐，始终位于操作按钮左侧；与主信息区视觉分离。
    - 状态视图归一：处置中（合并待处理/处理中/逾期）｜已完成｜已作废（合并忽略）。
  - 操作区（按钮组）：遵循 Ant Design 规范，按钮尺寸 small、主次分明，当前版本仅保留“查看详情”。
  - 对齐要求：侧栏整体靠右对齐；按钮永远位于行最右侧。

### 14.4 视觉与风险提示
- 行背景风险提示（不使用额外 Tag）：
  - 逾期：浅红底＋红色细边框。
  - 临近截止（<24h）：浅黄底＋黄色细边框。
  - 其他：白底，无边框。
- Tag 仅保留两类（优先级、任务类型）与右侧的状态 Tag；禁止额外风险类 Tag 以避免视觉噪音。

### 14.5 状态与时间的业务规则
- 状态归一展示：
  - 处置中 = 待处理 + 处理中 + 逾期
  - 已完成 = 已完成
  - 已作废 = 已忽略/取消/无效（依据业务映射）
- 时间字段选择：
  - 若任务处于“已完成”，展示“完成时间”。
  - 其他状态展示“截止时间”；若当前时间>截止时间，视为已逾期；若0<剩余<24小时，标记为临期并展示剩余小时数。

### 14.6 操作区（按钮组）
- 现有按钮：
  - 查看详情（按钮 + 图标）：跳转至工单详情页；保持在新页面打开（统一路由）。
- 移除按钮：催办、升级等暂不提供，待明确业务规则后再纳入。
- 按钮态：
  - 禁用：当任务无查看权限时（显示置灰 + 悬浮提示“无权限”）。
  - 加载：点击后可展示轻量 loading 态（不要求阻塞其他交互）。

### 14.7 筛选、排序与分页
- 状态视图筛选：全部｜处置中｜已完成｜已作废（与状态归一一致）。
- 任务类型筛选（层级多选）：
  - 一级类型与二级类型组成树形；默认“全部未选中”（等价于全部类型）。
  - 可多选一级或二级；勾选一级时等价选中其全部二级；勾选部分二级时父级呈半选态。
  - 支持搜索（按一级/二级名称检索）；支持分组展开/收起；筛选结果以可关闭的“条件标签”展示。
- 时间范围：创建时间范围（快捷：近7天、近30天、自定义）。
- 关键词：针对标题/任务编号模糊匹配。
- 排序（默认）：创建时间倒序；业务可配置支持截止时间/优先级排序（单字段）。
- 分页：每页 10/20/50/100 可选；显示总数与当前页。

### 14.11 任务类型层级与字典（用于筛选）
- 一级｜二级定义（全部工单均归属到具体“二级类型”，用于精准筛选）：
  - 告警处置：告警处置
  - 事件处置：事件处置
  - 芮错行处置：弱口令、主机漏洞、web漏洞、配置核查
  - 远程访问：远程访问
  - 网络准入：互联网准入、政务外网准入
  - 专项检查：专项检查、测评支持
  - 资源发布：系统上线、资源回收
  - 安全加固：安全加固、应急处置
- 口径：二级类型是筛选的最小粒度；当仅选择一级类型时，等价选择其全部二级。

### 14.12 个人视角与范围口径
- 我的待办（默认视图）：当前处理人=我，或明确指派到我所属的团队/角色且由我承办的未完成任务（不含已完成/已作废）。
- 无“待认领”队列：系统不提供待认领范畴；未明确到个人的群组任务是否呈现在“我的待办”由业务路由规则决定（本期不引入新的队列）。

### 14.8 空态与异常
- 空数据：展示“暂无任务数据”与简短引导（如“调整筛选条件”）。
- 异常加载：展示统一错误提示与“刷新”建议。

### 14.9 交互细节与一致性
- 行点击：不作为进入详情的触发，仅右侧按钮“查看详情”可进入（避免误触）。
- 文案一致：按钮统一使用“查看详情”；编号提供复制能力；时间统一格式。
- 悬浮：标题、超长文本悬浮显示完整内容。

### 14.10 验收要点
- 列表项仅保留“优先级 Tag、任务类型 Tag、标题、编号、创建时间、发起人、当前处理人、时间字段（完成/截止）”；不出现“责任单位/上一环节审批人/描述/进度条”。（现有列表与详情信息结构保持不变）
- 状态 Tag 位于右侧侧栏，且与操作按钮分列展示；按钮始终贴近最右侧。
- 逾期/临期仅通过行背景与边框提示，不额外添加 Tag。
- 筛选/分页可用，默认排序为创建时间倒序。
 - 默认视图：进入即呈现“我的待办”（我负责的 + 状态=待处理/处理中/逾期 + 任务类型=全部）。
 - 取消任务类型 Tab：任务类型以“层级多选筛选”呈现；支持选择一级/二级并以条件标签展示，可清空恢复默认视图。
 - 无待认领：页面与筛选不出现“待认领”相关元素或文案。

---

### 附录 A：字段字典（确定值域）
- status：draft｜processing｜returned｜on_hold｜resolved｜closed｜canceled
- priority：P0｜P1｜P2｜P3
- outcome（办理结果）：success｜failed｜partial
- dataItem.status：pending｜success｜failed｜skipped｜rolled_back
