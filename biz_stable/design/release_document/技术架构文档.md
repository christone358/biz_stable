# 业务稳定性监控系统 - 技术架构文档

## 文档信息
- 版本：v2.1.0
- 创建日期：2025-09-28
- 更新日期：2025-09-28
- 文档状态：最新

## 📋 目录
1. [系统概述](#系统概述)
2. [技术栈选型](#技术栈选型)
3. [系统架构](#系统架构)
4. [数据流设计](#数据流设计)
5. [组件架构](#组件架构)
6. [状态管理](#状态管理)
7. [数据层设计](#数据层设计)
8. [构建部署](#构建部署)
9. [性能优化](#性能优化)
10. [安全考虑](#安全考虑)

## 系统概述

### 项目背景
业务稳定性监控系统是一个基于React的企业级仪表板应用，用于实时监控政府各部门的IT基础设施、业务系统和资产健康状况。系统采用现代化的前端技术栈，提供直观的数据可视化和交互体验。

### 核心功能
- **四级层次监控**：根节点 → 部门 → 系统 → 资产
- **多维度展示**：KPI指标、健康矩阵、详情面板、告警监控
- **交互式导航**：组织树导航、矩阵图钻取、面包屑返回
- **实时数据**：动态筛选、状态同步、告警推送

## 技术栈选型

### 前端框架
```
├── React 18.2.0                    # 主框架
├── TypeScript 5.x                  # 类型系统
├── Vite 5.x                        # 构建工具
└── React Router 6.x                # 路由管理
```

### UI组件库
```
├── Ant Design 5.x                  # 主要UI组件
├── @ant-design/icons               # 图标库
├── CSS Custom Properties           # 样式变量
└── CSS Modules                     # 样式隔离
```

### 状态管理
```
├── Redux Toolkit 2.x               # 状态管理
├── React-Redux 9.x                 # React绑定
├── Immer                           # 不可变数据
└── Redux DevTools                  # 开发调试
```

### 数据可视化
```
├── D3.js 7.x                       # 核心可视化库
├── SVG                             # 矢量图形
├── Canvas (备选)                    # 高性能渲染
└── 自定义算法                       # 布局计算
```

### 开发工具
```
├── ESLint                          # 代码检查
├── Prettier                        # 代码格式化
├── Husky                           # Git钩子
├── dayjs                           # 时间处理
└── Mock.js (可选)                   # 数据模拟
```

## 系统架构

### 整体架构图
```
┌─────────────────────────────────────────────────────────┐
│                    业务稳定性监控系统                      │
├─────────────────────────────────────────────────────────┤
│  Presentation Layer (表现层)                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │
│  │ 组织树导航   │ │ 健康矩阵图   │ │    系统详情面板     │ │
│  │             │ │             │ │                     │ │
│  │OrganizationT│ │HealthMatrix │ │   SystemDetail      │ │
│  │ree          │ │             │ │                     │ │
│  └─────────────┘ └─────────────┘ └─────────────────────┘ │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                KPI指标卡片                          │ │
│  │                KPICards                            │ │
│  └─────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                告警监控面板                          │ │
│  │                AlertPanel                          │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  State Management Layer (状态管理层)                     │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                Redux Store                          │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐ │ │
│  │  │Dashboard    │ │Organization │ │    Assets       │ │ │
│  │  │Slice        │ │  State      │ │    State        │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  Data Layer (数据层)                                     │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                Mock Data Service                    │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐ │ │
│  │  │组织架构数据 │ │ 系统资产数据 │ │   告警漏洞数据   │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 模块划分
```
src/
├── pages/                          # 页面组件
│   ├── Dashboard/                  # 主仪表板页面
│   └── MockConfig/                 # Mock配置页面
├── components/                     # 业务组件
│   └── dashboard/                  # 仪表板相关组件
│       ├── OrganizationTree/       # 组织架构树
│       ├── KPICards/              # KPI指标卡片
│       ├── HealthMatrix/          # 健康矩阵图
│       ├── SystemDetail/          # 系统详情面板
│       └── AlertPanel/            # 告警监控面板
├── store/                          # 状态管理
│   ├── index.ts                   # Store配置
│   └── slices/                    # Redux切片
│       └── dashboardSlice.ts      # 仪表板状态
├── mock/                          # 模拟数据
│   └── data.ts                    # 数据生成器
├── types/                         # 类型定义
│   └── index.ts                   # 全局类型
└── utils/                         # 工具函数
    ├── constants.ts               # 常量定义
    └── helpers.ts                 # 帮助函数
```

## 数据流设计

### 数据流图
```
┌─────────────┐    用户交互    ┌─────────────────┐
│    用户操作  │ ────────────▶ │     组件事件     │
└─────────────┘                └─────────────────┘
                                        │
                                        ▼
┌─────────────┐   dispatch   ┌─────────────────┐
│ Redux Store │ ◀─────────── │   Action派发    │
└─────────────┘                └─────────────────┘
       │                                ▲
       │ subscribe                      │
       ▼                                │
┌─────────────┐   selector   ┌─────────────────┐
│  组件重渲染  │ ────────────▶ │   状态选择器     │
└─────────────┘                └─────────────────┘
```

### 核心数据流
1. **用户交互**：点击树节点、矩阵图、面包屑导航
2. **事件处理**：组件内处理点击事件
3. **Action派发**：dispatch相应的Redux action
4. **状态更新**：reducer处理并更新store状态
5. **组件重渲染**：通过useSelector监听状态变化
6. **界面同步**：所有相关组件同步更新

### 关键状态变更
```typescript
// 树节点选择流程
handleNodeClick(node)
  ↓
dispatch(setSelectedOrganization(node))
  ↓
更新selectedOrganization状态
  ↓
触发所有使用该状态的组件重渲染
  ↓
KPICards、HealthMatrix、SystemDetail、AlertPanel同步更新
```

## 组件架构

### 组件层次结构
```
Dashboard (主页面)
├── KPICards (KPI指标卡片)
├── 中间区域
│   ├── OrganizationTree (组织架构树)
│   ├── HealthMatrix (健康矩阵图)
│   └── SystemDetail (系统详情面板)
└── AlertPanel (告警监控面板)
```

### 核心组件设计

#### 1. OrganizationTree 组织架构树
```typescript
interface OrganizationTreeProps {
  // 无外部props，通过Redux获取数据
}

// 内部状态管理
const OrganizationTree: React.FC = () => {
  const { organizations, selectedOrganization } = useSelector(...)

  // 节点点击处理
  const handleNodeClick = (node: OrganizationNode) => {
    dispatch(setSelectedOrganization(node))
    // 根据节点类型设置不同的数据
  }

  // 展开/折叠处理
  const handleExpandClick = (node: OrganizationNode) => {
    // 懒加载子节点数据
  }
}
```

#### 2. HealthMatrix 健康矩阵图
```typescript
interface HealthMatrixProps {
  // 无外部props，通过Redux获取数据
}

// D3.js可视化组件
const HealthMatrix: React.FC = () => {
  const svgRef = useRef<SVGSVGElement>(null)
  const { filteredAssets, selectedAssetId } = useSelector(...)

  useEffect(() => {
    // D3.js渲染逻辑
    const svg = d3.select(svgRef.current)

    // 绘制矩阵和蜂窝图
    renderMatrix(svg, filteredAssets)

    // 设置交互事件
    svg.selectAll('.hexagon')
      .on('click', handleHexagonClick)
      .on('mouseover', showTooltip)
      .on('mouseout', hideTooltip)

    // 清理函数
    return () => {
      svg.selectAll('*').remove()
    }
  }, [filteredAssets, selectedAssetId])
}
```

#### 3. SystemDetail 系统详情面板
```typescript
interface SystemDetailProps {
  // 无外部props，通过Redux获取数据
}

// 动态内容展示组件
const SystemDetail: React.FC = () => {
  const { selectedOrganization, filteredAssets, selectedAssetId } = useSelector(...)

  // 根据选择状态计算显示内容
  const displayContent = useMemo(() => {
    if (selectedAssetId) return { type: 'assetDetail', data: asset }
    if (selectedOrganization?.type === 'root') return { type: 'systemsList', data: systems }
    if (selectedOrganization?.type === 'department') return { type: 'departmentSystems', data: departmentSystems }
    if (selectedOrganization?.type === 'system') return { type: 'systemDetail', data: systemDetail }
    return { type: 'empty', data: null }
  }, [selectedOrganization, filteredAssets, selectedAssetId])

  // 渲染不同类型的内容
  return (
    <div className="system-detail-container">
      {displayContent.type === 'systemsList' && renderSystemsList(displayContent.data)}
      {displayContent.type === 'departmentSystems' && renderDepartmentSystems(displayContent.data)}
      {displayContent.type === 'systemDetail' && renderSystemDetail(displayContent.data)}
      {displayContent.type === 'assetDetail' && renderAssetDetail(displayContent.data)}
    </div>
  )
}
```

#### 4. AlertPanel 告警监控面板
```typescript
interface AlertPanelProps {
  // 无外部props，通过Redux获取数据
}

// 告警监控组件
const AlertPanel: React.FC = () => {
  const { selectedOrganization, filteredAssets } = useSelector(...)
  const [items, setItems] = useState<AlertPanelItem[]>([])

  // 根据选择范围加载告警数据
  useEffect(() => {
    loadData()
  }, [selectedOrganization, filteredAssets])

  // 按类型分组告警
  const groupedItems = useMemo(() => ({
    runtime: items.filter(item => item.type === 'RUNTIME'),
    vulnerability: items.filter(item => item.type === 'VULNERABILITY'),
    security: items.filter(item => item.type === 'SECURITY')
  }), [items])
}
```

## 状态管理

### Redux Store结构
```typescript
interface RootState {
  dashboard: DashboardState
}

interface DashboardState {
  // 选择状态
  selectedOrganization: OrganizationNode | null
  selectedDepartmentId: string | null
  selectedAssetId: string | null

  // 数据状态
  organizations: OrganizationNode[]
  systems: BusinessSystem[]
  filteredAssets: Asset[]
  metrics: DashboardMetrics | null
  alerts: Alert[]
  vulnerabilities: Vulnerability[]

  // UI状态
  filters: FilterOptions
  loading: boolean
  error: string | null
}
```

### Action设计
```typescript
// 选择相关Actions
setSelectedOrganization(organization: OrganizationNode)
setSelectedDepartmentId(departmentId: string | null)
setSelectedAssetId(assetId: string | null)

// 数据相关Actions
setOrganizations(organizations: OrganizationNode[])
setSystems(systems: BusinessSystem[])
setFilteredAssets(assets: Asset[])
setMetrics(metrics: DashboardMetrics)
setAlerts(alerts: Alert[])
setVulnerabilities(vulnerabilities: Vulnerability[])

// 树状态管理Actions
toggleOrganizationExpand(nodeId: string)
expandOrganizationNode(payload: { nodeId: string, children: OrganizationNode[] })

// UI状态Actions
setFilters(filters: FilterOptions)
setLoading(loading: boolean)
setError(error: string | null)
```

### 状态更新模式
```typescript
// 1. 同步更新模式
const handleNodeClick = (node: OrganizationNode) => {
  dispatch(setSelectedOrganization(node))

  if (node.type === 'department') {
    const departmentSystems = allSystems.filter(sys => sys.departmentId === node.id)
    dispatch(setSystems(departmentSystems))
    dispatch(setFilteredAssets(getAssetsForDepartment(node.id)))
    dispatch(setSelectedDepartmentId(node.id))
    dispatch(setSelectedAssetId(null)) // 清除资产选择
  }
}

// 2. 条件更新模式
const handleHexagonClick = (asset: Asset) => {
  if (selectedOrganization?.type === 'system') {
    dispatch(setSelectedAssetId(asset.id))
    // 不改变其他状态，保持系统级别的上下文
  }
}
```

## 数据层设计

### Mock数据架构
```typescript
// 确定性随机算法
const generateDeterministicData = (seed: string, count: number) => {
  const hash = generateHash(seed)
  const result = []

  for (let i = 0; i < count; i++) {
    const itemSeed = Math.abs(hash + i * 1234567) % 1000000
    result.push(generateItem(itemSeed))
  }

  return result
}

// 分层数据生成
├── generateMockOrganizations()     # 组织架构数据
├── generateMockSystems()           # 业务系统数据
├── generateAssetsForSystem()       # 系统资产数据
├── generateMockAlerts()            # 告警数据
├── generateMockVulnerabilities()   # 漏洞数据
└── generateMockMetrics()           # KPI指标数据
```

### 数据关联关系
```
组织架构 (Organizations)
├── id, name, type, children
├── systemCount, assetCount
└── healthStatus

业务系统 (BusinessSystems)
├── id, name, departmentId
├── assets[], assetCount
├── alertCount, vulnerabilityCount
└── healthStatus, metrics

资产信息 (Assets)
├── id, name, type, systemId
├── healthStatus, importance
├── ipAddress, description
└── metrics, lastCheck

告警数据 (Alerts)
├── id, systemId, level, type
├── title, description, status
└── timestamp, impact

漏洞数据 (Vulnerabilities)
├── id, cveId, systemId
├── severity, cvssScore
├── title, description, status
└── discoveryDate, fixRecommendation
```

## 构建部署

### 构建配置
```typescript
// vite.config.ts
export default defineConfig({
  plugins: [react()],
  build: {
    target: 'es2020',
    minify: 'terser',
    sourcemap: true,
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          redux: ['@reduxjs/toolkit', 'react-redux'],
          antd: ['antd', '@ant-design/icons'],
          d3: ['d3']
        }
      }
    }
  },
  server: {
    port: 3000,
    host: true
  }
})
```

### 部署策略
```bash
# 开发环境
npm run dev          # 启动开发服务器

# 生产构建
npm run build        # 构建生产版本
npm run preview      # 预览生产版本

# 部署流程
1. 代码提交到Git仓库
2. CI/CD流水线自动构建
3. 构建产物部署到CDN
4. 配置Nginx反向代理
5. 监控部署状态
```

### 环境配置
```typescript
// 环境变量
VITE_API_BASE_URL=     # API基础URL
VITE_ENV=              # 环境标识
VITE_ENABLE_MOCK=      # 是否启用Mock数据

// 配置文件
├── .env                # 默认配置
├── .env.development    # 开发环境
├── .env.production     # 生产环境
└── .env.local          # 本地配置
```

## 性能优化

### 渲染优化
```typescript
// 1. 组件记忆化
const MemoizedComponent = React.memo(Component, (prevProps, nextProps) => {
  return shallowEqual(prevProps, nextProps)
})

// 2. 状态选择器优化
const selectedData = useSelector(state => ({
  organization: state.dashboard.selectedOrganization,
  assets: state.dashboard.filteredAssets
}), shallowEqual)

// 3. useMemo缓存计算
const displayContent = useMemo(() => {
  return computeDisplayContent(selectedOrganization, filteredAssets)
}, [selectedOrganization, filteredAssets])

// 4. useCallback缓存函数
const handleNodeClick = useCallback((node: OrganizationNode) => {
  dispatch(setSelectedOrganization(node))
}, [dispatch])
```

### D3.js性能优化
```typescript
// 1. 数据绑定优化
const update = svg.selectAll('.hexagon')
  .data(data, d => d.id) // 使用key函数

update.enter()
  .append('path')
  .attr('class', 'hexagon')
  .merge(update) // 合并enter和update选择集
  .attr('d', hexagonPath)
  .attr('fill', d => colorScale(d.healthStatus))

update.exit().remove() // 移除多余元素

// 2. 事件委托
svg.on('click', function(event) {
  const target = event.target
  if (target.classList.contains('hexagon')) {
    handleHexagonClick(d3.select(target).datum())
  }
})

// 3. 虚拟化渲染
if (data.length > 1000) {
  // 只渲染可视区域内的元素
  const visibleData = getVisibleData(data, viewport)
  renderHexagons(visibleData)
}
```

### 资源优化
```typescript
// 1. 代码分割
const MockConfig = lazy(() => import('./pages/MockConfig'))

// 2. 资源预加载
<link rel="preload" href="/assets/fonts/inter.woff2" as="font" type="font/woff2" crossorigin>

// 3. 图片优化
// 使用WebP格式
// 压缩SVG图标
// 合理设置图片尺寸

// 4. 缓存策略
// 设置静态资源缓存头
// 使用Service Worker缓存
// 实现接口数据缓存
```

## 安全考虑

### 前端安全
```typescript
// 1. XSS防护
const SafeHTML = ({ content }: { content: string }) => {
  const sanitized = DOMPurify.sanitize(content)
  return <div dangerouslySetInnerHTML={{ __html: sanitized }} />
}

// 2. CSRF防护
axios.defaults.xsrfCookieName = 'XSRF-TOKEN'
axios.defaults.xsrfHeaderName = 'X-XSRF-TOKEN'

// 3. 敏感信息保护
// 不在前端存储敏感数据
// 使用HTTPS传输
// 设置安全响应头

// 4. 输入验证
const validateInput = (input: string) => {
  // 长度限制
  if (input.length > 1000) return false

  // 特殊字符过滤
  const dangerousChars = /<script|javascript:|data:/i
  if (dangerousChars.test(input)) return false

  return true
}
```

### 数据安全
```typescript
// 1. 接口权限控制
const apiClient = axios.create({
  baseURL: process.env.VITE_API_BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// 2. 错误信息脱敏
const handleError = (error: any) => {
  console.error('API Error:', error) // 开发环境记录详细错误

  // 生产环境返回通用错误信息
  if (process.env.NODE_ENV === 'production') {
    return '系统错误，请稍后重试'
  }

  return error.message
}

// 3. 日志安全
const logger = {
  info: (message: string, data?: any) => {
    if (process.env.NODE_ENV === 'development') {
      console.log(message, data)
    }
    // 生产环境发送到日志服务
  },

  error: (message: string, error?: any) => {
    // 记录错误但不暴露敏感信息
    const safeError = {
      message: error?.message,
      stack: process.env.NODE_ENV === 'development' ? error?.stack : undefined
    }
    console.error(message, safeError)
  }
}
```

---

## 📚 相关文档
- [功能更新文档](./功能更新文档.md)
- [UI-UX设计规范](./UI-UX设计规范.md)
- [接口规范文档](./接口规范文档.md)
- [产品需求文档PRD](./产品需求文档PRD.md)
- [开发指南](../CLAUDE.md)

---

**文档维护**: 请在系统功能或架构发生变化时及时更新本文档